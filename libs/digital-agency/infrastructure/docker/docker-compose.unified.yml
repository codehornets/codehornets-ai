name: handymate-unified

services:
  # ============================================================================
  # Single Multi-Tenant Application (replaces 8 separate apps)
  # ============================================================================
  app:
    build:
      context: ../..
      dockerfile: infrastructure/docker/Dockerfile.unified
      args:
        - PHP_VERSION=8.3
    container_name: handymate-app
    restart: unless-stopped
    working_dir: /var/www/html
    volumes:
      - ../../workspaces/handymate:/var/www/html
      - vendor-data:/var/www/html/vendor
      - node_modules-data:/var/www/html/node_modules
      - ../../storage/app:/var/www/html/storage/app
      - ../../storage/logs:/var/www/html/storage/logs
    ports:
      - "${APP_PORT:-80}:80"
      - "${VITE_PORT:-5173}:5173"
    environment:
      - APP_ENV=${APP_ENV:-local}
      - APP_DEBUG=${APP_DEBUG:-true}
      - DB_CONNECTION=mysql
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_DATABASE=${DB_DATABASE:-handymate_unified}
      - DB_USERNAME=${DB_USERNAME:-handymate}
      - DB_PASSWORD=${DB_PASSWORD:-secret}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - CACHE_DRIVER=redis
      - SESSION_DRIVER=redis
      - QUEUE_CONNECTION=redis
      # AI Services
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - handymate-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # MySQL Database (Single unified database)
  # ============================================================================
  mysql:
    image: mysql:8.0
    container_name: handymate-mysql
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${DB_DATABASE:-handymate_unified}
      MYSQL_USER: ${DB_USERNAME:-handymate}
      MYSQL_PASSWORD: ${DB_PASSWORD:-secret}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    volumes:
      - mysql-data:/var/lib/mysql
      - ./mysql/my.cnf:/etc/mysql/conf.d/my.cnf
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - handymate-network

  # ============================================================================
  # Redis Cache & Queue
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: handymate-redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - handymate-network

  # ============================================================================
  # Laravel Queue Workers (Auto-scaling)
  # ============================================================================
  queue:
    build:
      context: ../..
      dockerfile: infrastructure/docker/Dockerfile.unified
      args:
        - PHP_VERSION=8.3
    container_name: handymate-queue
    restart: unless-stopped
    working_dir: /var/www/html
    command: php artisan queue:work --sleep=3 --tries=3 --max-time=3600
    volumes:
      - ../../workspaces/handymate:/var/www/html
      - vendor-data:/var/www/html/vendor
    environment:
      - APP_ENV=${APP_ENV:-local}
      - DB_HOST=mysql
      - DB_DATABASE=${DB_DATABASE:-handymate_unified}
      - REDIS_HOST=redis
      - QUEUE_CONNECTION=redis
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - handymate-network
    deploy:
      replicas: 2
      resources:
        limits:
          cpus: '1'
          memory: 512M

  # ============================================================================
  # Agent Queue Workers (for AI agent tasks)
  # ============================================================================
  queue-agents:
    build:
      context: ../..
      dockerfile: infrastructure/docker/Dockerfile.unified
      args:
        - PHP_VERSION=8.3
    container_name: handymate-queue-agents
    restart: unless-stopped
    working_dir: /var/www/html
    command: php artisan queue:work redis --queue=agents --sleep=1 --tries=3 --timeout=300
    volumes:
      - ../../workspaces/handymate:/var/www/html
      - vendor-data:/var/www/html/vendor
    environment:
      - APP_ENV=${APP_ENV:-local}
      - DB_HOST=mysql
      - DB_DATABASE=${DB_DATABASE:-handymate_unified}
      - REDIS_HOST=redis
      - QUEUE_CONNECTION=redis
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - handymate-network
    deploy:
      replicas: 3  # Scale based on agent workload
      resources:
        limits:
          cpus: '2'
          memory: 1G

  # ============================================================================
  # n8n Workflow Automation (Agent Orchestration)
  # ============================================================================
  n8n:
    image: n8nio/n8n:1.68.0
    container_name: handymate-n8n
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      - DB_TYPE=mysqldb
      - DB_MYSQLDB_HOST=mysql
      - DB_MYSQLDB_PORT=3306
      - DB_MYSQLDB_DATABASE=${N8N_DB_DATABASE:-handymate_n8n}
      - DB_MYSQLDB_USER=${DB_USERNAME:-handymate}
      - DB_MYSQLDB_PASSWORD=${DB_PASSWORD:-secret}
      - N8N_HOST=${N8N_HOST:-localhost}
      - N8N_PORT=5678
      - N8N_PROTOCOL=${N8N_PROTOCOL:-http}
      - WEBHOOK_URL=${N8N_WEBHOOK_URL:-http://localhost/api/webhooks}
      - EXECUTIONS_MODE=queue
      - QUEUE_BULL_REDIS_HOST=redis
      - QUEUE_BULL_REDIS_PORT=6379
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - GENERIC_TIMEZONE=${APP_TIMEZONE:-America/New_York}
    ports:
      - "${N8N_PORT:-5678}:5678"
    volumes:
      - n8n-data:/home/node/.n8n
      - ../../storage/logs/n8n:/data/logs
    networks:
      - handymate-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:5678/healthz || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # n8n Workers (Scale horizontally based on workload)
  # ============================================================================
  n8n-worker:
    image: n8nio/n8n:1.68.0
    container_name: handymate-n8n-worker
    restart: unless-stopped
    depends_on:
      n8n:
        condition: service_healthy
    command: worker
    environment:
      - DB_TYPE=mysqldb
      - DB_MYSQLDB_HOST=mysql
      - DB_MYSQLDB_PORT=3306
      - DB_MYSQLDB_DATABASE=${N8N_DB_DATABASE:-handymate_n8n}
      - DB_MYSQLDB_USER=${DB_USERNAME:-handymate}
      - DB_MYSQLDB_PASSWORD=${DB_PASSWORD:-secret}
      - EXECUTIONS_MODE=queue
      - QUEUE_BULL_REDIS_HOST=redis
      - QUEUE_BULL_REDIS_PORT=6379
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
    volumes:
      - n8n-data:/home/node/.n8n
    networks:
      - handymate-network
    deploy:
      replicas: 2  # Scale based on workflow volume
      resources:
        limits:
          cpus: '1'
          memory: 1G

  # ============================================================================
  # Mailhog (Development email testing)
  # ============================================================================
  mailhog:
    image: mailhog/mailhog:latest
    container_name: handymate-mailhog
    restart: unless-stopped
    ports:
      - "${MAILHOG_SMTP_PORT:-1025}:1025"
      - "${MAILHOG_UI_PORT:-8025}:8025"
    networks:
      - handymate-network

volumes:
  mysql-data:
    driver: local
  redis-data:
    driver: local
  n8n-data:
    driver: local
  vendor-data:
    driver: local
  node_modules-data:
    driver: local

networks:
  handymate-network:
    driver: bridge

# ============================================================================
# Summary:
#   Reduced from 22 containers to 8-10 containers (60% reduction)
#   Single database instead of 8 (87% reduction)
#   Agent-based scaling instead of app-based
#   Cost savings: ~70%
# ============================================================================
