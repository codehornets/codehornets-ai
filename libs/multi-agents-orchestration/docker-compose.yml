name: codehornets-ai

services:
  # Redis for coordination (optional)
  redis:
    image: redis:7-alpine
    container_name: codehornets-svc-redis
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    networks:
      - claude-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  # Orchestrator - Coordinates workers
  orchestrator:
    image: docker/sandbox-templates:claude-code
    container_name: codehornets-orchestrator
    entrypoint: ["/tools/orchestrator_entrypoint.sh"]
    group_add:
      - "0"     # Root group for Docker socket access
      - "1001"  # Docker group on host (if different)
    volumes:
      - ./prompts:/prompts:ro
      - ./hooks-config:/hooks-config:ro
      - ./tools:/tools:ro
      - ./requirements.txt:/requirements.txt:ro
      - ./shared/auth-homes/orchestrator:/home/agent/.claude:rw
      - ./shared/tasks:/tasks:rw
      - ./shared/results:/results:ro
      - ./shared/heartbeats:/shared/heartbeats:rw
      - ./shared/triggers:/shared/triggers:rw
      - ./shared/pipes:/shared/pipes:rw
      - ./shared/watcher-logs:/var/log:rw
      - ./shared/workspaces:/workspaces:ro
      - /var/run/docker.sock:/var/run/docker.sock:rw
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - HOOKS_MODE=${HOOKS_MODE:-enabled}
      - TRIGGER_DIR=/shared/triggers
      - PIPE_DIR=/shared/pipes
      - TASKS_DIR=/tasks
      - RESULTS_DIR=/results
      - HEARTBEAT_DIR=/shared/heartbeats
      - AGENT_NAME=orchestrator
      - AGENT_ROLE=orchestrator
    networks:
      - claude-network
    stdin_open: true
    tty: true
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
        required: false

  # Marie - Frontend worker
  marie:
    image: docker/sandbox-templates:claude-code
    container_name: codehornets-worker-marie
    entrypoint: ["/tools/entrypoint.sh"]
    command: ["marie"]
    group_add:
      - "0"     # Root group for Docker socket access
      - "1001"  # Docker group on host
    volumes:
      - ./prompts:/prompts:ro
      - ./hooks-config:/hooks-config:ro
      - ./tools:/tools:ro
      - ./requirements.txt:/requirements.txt:ro
      - ./shared/auth-homes/marie:/home/agent/.claude:rw
      - ./shared/tasks/marie:/tasks:ro
      - ./shared/results/marie:/results:rw
      - ./shared/heartbeats:/shared/heartbeats:rw
      - ./shared/triggers/marie:/shared/triggers:rw
      - ./shared/pipes:/shared/pipes:rw
      - ./shared/watcher-logs:/var/log:rw
      - ./shared/workspaces/marie:/home/agent/workspace:rw
      - /var/run/docker.sock:/var/run/docker.sock:rw
    environment:
      - ACTIVATION_WRAPPER=${ACTIVATION_WRAPPER:-}
      - ACTIVATION_MODE=${ACTIVATION_MODE:-inotify}
      - HOOKS_MODE=${HOOKS_MODE:-enabled}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - TASK_DIR=/tasks
      - RESULT_DIR=/results
      - HEARTBEAT_DIR=/shared/heartbeats
      - HEARTBEAT_INTERVAL=${HEARTBEAT_INTERVAL:-10}
      - TRIGGER_DIR=/shared/triggers
      - PIPE_DIR=/shared/pipes
      - WORKER_NAME=marie
      - AGENT_NAME=marie
      - AGENT_ROLE=worker
    networks:
      - claude-network
    stdin_open: true
    tty: true
    stop_grace_period: 60s
    stop_signal: SIGTERM
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "test", "-f", "/shared/heartbeats/marie.json"]
      interval: 15s
      timeout: 5s
      retries: 3
    depends_on:
      redis:
        condition: service_healthy
        required: false

  # Anga - Backend worker
  anga:
    image: docker/sandbox-templates:claude-code
    container_name: codehornets-worker-anga
    entrypoint: ["/tools/entrypoint.sh"]
    command: ["anga"]
    group_add:
      - "0"     # Root group for Docker socket access
      - "1001"  # Docker group on host
    volumes:
      - ./prompts:/prompts:ro
      - ./hooks-config:/hooks-config:ro
      - ./tools:/tools:ro
      - ./requirements.txt:/requirements.txt:ro
      - ./shared/auth-homes/anga:/home/agent/.claude:rw
      - ./shared/tasks/anga:/tasks:ro
      - ./shared/tasks/anga:/home/agent/workspace/tasks:ro
      - ./shared/results/anga:/results:rw
      - ./shared/results/anga:/home/agent/workspace/results:rw
      - ./shared/heartbeats:/shared/heartbeats:rw
      - ./shared/triggers/anga:/shared/triggers:rw
      - ./shared/pipes:/shared/pipes:rw
      - ./shared/watcher-logs:/var/log:rw
      - ./shared/workspaces/anga:/home/agent/workspace:rw
      - /var/run/docker.sock:/var/run/docker.sock:rw
    environment:
      - ACTIVATION_WRAPPER=${ACTIVATION_WRAPPER:-}
      - ACTIVATION_MODE=${ACTIVATION_MODE:-inotify}
      - HOOKS_MODE=${HOOKS_MODE:-enabled}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - TASK_DIR=/tasks
      - RESULT_DIR=/results
      - HEARTBEAT_DIR=/shared/heartbeats
      - HEARTBEAT_INTERVAL=${HEARTBEAT_INTERVAL:-10}
      - TRIGGER_DIR=/shared/triggers
      - PIPE_DIR=/shared/pipes
      - WORKER_NAME=anga
      - AGENT_NAME=anga
      - AGENT_ROLE=worker
    networks:
      - claude-network
    stdin_open: true
    tty: true
    stop_grace_period: 60s
    stop_signal: SIGTERM
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "test", "-f", "/shared/heartbeats/anga.json"]
      interval: 15s
      timeout: 5s
      retries: 3
    depends_on:
      redis:
        condition: service_healthy
        required: false

  # Fabien - DevOps worker
  fabien:
    image: docker/sandbox-templates:claude-code
    container_name: codehornets-worker-fabien
    entrypoint: ["/tools/entrypoint.sh"]
    command: ["fabien"]
    group_add:
      - "0"     # Root group for Docker socket access
      - "1001"  # Docker group on host
    volumes:
      - ./prompts:/prompts:ro
      - ./hooks-config:/hooks-config:ro
      - ./tools:/tools:ro
      - ./requirements.txt:/requirements.txt:ro
      - ./shared/auth-homes/fabien:/home/agent/.claude:rw
      - ./shared/tasks/fabien:/tasks:ro
      - ./shared/results/fabien:/results:rw
      - ./shared/heartbeats:/shared/heartbeats:rw
      - ./shared/triggers/fabien:/shared/triggers:rw
      - ./shared/pipes:/shared/pipes:rw
      - ./shared/watcher-logs:/var/log:rw
      - ./shared/workspaces/fabien:/home/agent/workspace:rw
      - /var/run/docker.sock:/var/run/docker.sock:rw
    environment:
      - ACTIVATION_WRAPPER=${ACTIVATION_WRAPPER:-}
      - ACTIVATION_MODE=${ACTIVATION_MODE:-inotify}
      - HOOKS_MODE=${HOOKS_MODE:-enabled}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - TASK_DIR=/tasks
      - RESULT_DIR=/results
      - HEARTBEAT_DIR=/shared/heartbeats
      - HEARTBEAT_INTERVAL=${HEARTBEAT_INTERVAL:-10}
      - TRIGGER_DIR=/shared/triggers
      - PIPE_DIR=/shared/pipes
      - WORKER_NAME=fabien
      - AGENT_NAME=fabien
      - AGENT_ROLE=worker
    networks:
      - claude-network
    stdin_open: true
    tty: true
    stop_grace_period: 60s
    stop_signal: SIGTERM
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "test", "-f", "/shared/heartbeats/fabien.json"]
      interval: 15s
      timeout: 5s
      retries: 3
    depends_on:
      redis:
        condition: service_healthy
        required: false

  # Automation Helper - Sends messages to workers via expect
  automation:
    image: alpine:latest
    container_name: codehornets-svc-automation
    command: >
      sh -c "
      echo 'üì¶ Installing automation tools...' &&
      apk add --no-cache bash expect docker-cli curl &&
      echo '‚úì Automation tools ready' &&
      echo 'üí§ Waiting for commands...' &&
      tail -f /dev/null
      "
    volumes:
      - ./tools:/tools:ro
      - ./shared:/workspace/shared:rw
      - /var/run/docker.sock:/var/run/docker.sock:rw
    networks:
      - claude-network
    restart: unless-stopped

  # Monitor - System observer with local LLM
  monitor:
    image: python:3.11-slim
    container_name: codehornets-svc-monitor
    command: >
      bash -c "
      echo 'üîç Installing monitor dependencies...' &&
      pip install --quiet --upgrade pip >/dev/null 2>&1 &&
      pip install --quiet --no-warn-script-location watchdog requests >/dev/null 2>&1 &&
      echo 'üì¶ Installing docker-cli...' &&
      apt-get update -qq >/dev/null 2>&1 &&
      apt-get install -y -qq docker.io >/dev/null 2>&1 &&
      echo '‚úì Dependencies installed' &&
      echo 'üì° Checking for Ollama on host...' &&
      if curl -s --max-time 2 http://host.docker.internal:11434/api/tags >/dev/null 2>&1 || \
         curl -s --max-time 2 http://172.17.0.1:11434/api/tags >/dev/null 2>&1; then
        echo '‚úì Ollama detected - AI recaps enabled';
      else
        echo '‚Ñπ Ollama not detected - using rule-based recaps';
        echo '  To enable AI recaps: Install Ollama on host and run: ollama pull llama3.2:1b';
      fi &&
      echo 'üëÅÔ∏è  Starting monitor daemon...' &&
      python3 /tools/monitor_daemon.py
      "
    volumes:
      - ./tools:/tools:ro
      - ./shared/tasks:/workspace/shared/tasks:rw
      - ./shared/results:/workspace/shared/results:rw
      - ./shared/heartbeats:/workspace/shared/heartbeats:ro
      - ./shared/triggers:/workspace/shared/triggers:rw
      - ./shared/archive:/workspace/shared/archive:rw
      - ./shared/watcher-logs:/workspace/shared/watcher-logs:rw
      - /var/run/docker.sock:/var/run/docker.sock:rw
    environment:
      - PYTHONUNBUFFERED=1
      - MONITOR_INTERVAL=${MONITOR_INTERVAL:-3}
      - LLM_MODEL=${LLM_MODEL:-llama3.2:1b}
    networks:
      - claude-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
        required: false

networks:
  claude-network:
    driver: bridge

volumes:
  redis-data:
