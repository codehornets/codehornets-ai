name: 'codehornets-ai-activated'

# Event-driven multi-agent orchestration with activation wrapper
# Zero CPU when idle, instant wakeup on task arrival

services:
  # Redis for pub/sub activation (optional, falls back to inotify)
  # Note: No external port exposed - workers connect via internal docker network
  redis:
    image: redis:8.0-rc1-alpine
    container_name: codehornets-redis
    # Removed external port mapping to avoid conflicts with other projects
    # Workers connect via internal network: redis://redis:6379
    networks:
      - claude-network
    restart: unless-stopped

  # Orchestrator - Coordinates workers
  orchestrator:
    image: docker/sandbox-templates:claude-code
    container_name: orchestrator
    command: >
      bash -c "
      cp /prompts/orchestrator.md /home/agent/workspace/CLAUDE.md &&
      claude
      "
    volumes:
      - ./prompts:/prompts:ro
      - ./shared/auth-homes/orchestrator:/home/agent/.claude:rw
      - ./shared/tasks:/tasks:rw
      - ./shared/results:/results:ro
      - ./shared/heartbeats:/shared/heartbeats:ro
      - ../workspaces:/workspaces:ro
    environment:
      - NODE_ENV=production
      - REDIS_URL=redis://redis:6379
    networks:
      - claude-network
    stdin_open: true
    tty: true
    restart: unless-stopped
    depends_on:
      - redis

  # Marie - Dance teacher assistant (EVENT-DRIVEN)
  marie:
    image: docker/sandbox-templates:claude-code
    container_name: marie
    command: >
      bash -c "
      echo 'ðŸ”§ Installing dependencies...' &&
      pip install --quiet --break-system-packages reportlab watchdog redis &&
      echo 'âœ… Dependencies installed' &&
      mkdir -p /home/agent/.claude/output-styles &&
      cp /output-styles/marie.md /home/agent/.claude/output-styles/marie.md &&
      echo '{\"outputStyle\": \"marie\"}' > /home/agent/.claude/settings.local.json &&
      echo 'ðŸš€ Starting activation wrapper...' &&
      python3 /tools/activation_wrapper.py marie --mode \${ACTIVATION_MODE}
      "
    volumes:
      - ./output-styles:/output-styles:ro
      - ./shared/auth-homes/marie:/home/agent/.claude:rw
      - ./shared/tasks/marie:/tasks:ro
      - ./shared/results/marie:/results:rw
      - ./shared/heartbeats:/shared/heartbeats:rw
      - ../workspaces/dance:/workspace/dance:rw
      - ./shared/workspaces/marie:/home/agent/workspace:rw
      - ../tools/pdf-generator:/tools/pdf-generator:ro
      - ../tools/activation_wrapper.py:/tools/activation_wrapper.py:ro
    environment:
      - ACTIVATION_MODE=${ACTIVATION_MODE:-inotify}  # inotify (fast) or redis (clustered)
      - REDIS_URL=redis://redis:6379
      - TASK_DIR=/tasks
      - RESULT_DIR=/results
      - HEARTBEAT_DIR=/shared/heartbeats
      - HEARTBEAT_INTERVAL=10
    networks:
      - claude-network
    stdin_open: true
    tty: true
    stop_grace_period: 60s
    stop_signal: SIGTERM
    restart: unless-stopped
    depends_on:
      - redis

  # Anga - Coding assistant (EVENT-DRIVEN)
  anga:
    image: docker/sandbox-templates:claude-code
    container_name: anga
    command: >
      bash -c "
      echo 'ðŸ”§ Installing dependencies...' &&
      pip install --quiet --break-system-packages watchdog redis &&
      echo 'âœ… Dependencies installed' &&
      mkdir -p /home/agent/.claude/output-styles &&
      cp /output-styles/anga.md /home/agent/.claude/output-styles/anga.md &&
      echo '{\"outputStyle\": \"anga\"}' > /home/agent/.claude/settings.local.json &&
      echo 'ðŸš€ Starting activation wrapper...' &&
      python3 /tools/activation_wrapper.py anga --mode \${ACTIVATION_MODE}
      "
    volumes:
      - ./output-styles:/output-styles:ro
      - ./shared/auth-homes/anga:/home/agent/.claude:rw
      - ./shared/tasks/anga:/tasks:ro
      - ./shared/results/anga:/results:rw
      - ./shared/heartbeats:/shared/heartbeats:rw
      - ../workspaces/coding:/workspace/coding:rw
      - ./shared/workspaces/anga:/home/agent/workspace:rw
      - ../tools/activation_wrapper.py:/tools/activation_wrapper.py:ro
    environment:
      - ACTIVATION_MODE=${ACTIVATION_MODE:-inotify}
      - REDIS_URL=redis://redis:6379
      - TASK_DIR=/tasks
      - RESULT_DIR=/results
      - HEARTBEAT_DIR=/shared/heartbeats
      - HEARTBEAT_INTERVAL=10
    networks:
      - claude-network
    stdin_open: true
    tty: true
    stop_grace_period: 60s
    stop_signal: SIGTERM
    restart: unless-stopped
    depends_on:
      - redis

  # Fabien - Marketing assistant (EVENT-DRIVEN)
  fabien:
    image: docker/sandbox-templates:claude-code
    container_name: fabien
    command: >
      bash -c "
      echo 'ðŸ”§ Installing dependencies...' &&
      pip install --quiet --break-system-packages watchdog redis &&
      echo 'âœ… Dependencies installed' &&
      mkdir -p /home/agent/.claude/output-styles &&
      cp /output-styles/fabien.md /home/agent/.claude/output-styles/fabien.md &&
      echo '{\"outputStyle\": \"fabien\"}' > /home/agent/.claude/settings.local.json &&
      echo 'ðŸš€ Starting activation wrapper...' &&
      python3 /tools/activation_wrapper.py fabien --mode \${ACTIVATION_MODE}
      "
    volumes:
      - ./output-styles:/output-styles:ro
      - ./shared/auth-homes/fabien:/home/agent/.claude:rw
      - ./shared/tasks/fabien:/tasks:ro
      - ./shared/results/fabien:/results:rw
      - ./shared/heartbeats:/shared/heartbeats:rw
      - ../workspaces/marketing:/workspace/marketing:rw
      - ./shared/workspaces/fabien:/home/agent/workspace:rw
      - ../tools/activation_wrapper.py:/tools/activation_wrapper.py:ro
    environment:
      - ACTIVATION_MODE=${ACTIVATION_MODE:-inotify}
      - REDIS_URL=redis://redis:6379
      - TASK_DIR=/tasks
      - RESULT_DIR=/results
      - HEARTBEAT_DIR=/shared/heartbeats
      - HEARTBEAT_INTERVAL=10
    networks:
      - claude-network
    stdin_open: true
    tty: true
    stop_grace_period: 60s
    stop_signal: SIGTERM
    restart: unless-stopped
    depends_on:
      - redis

networks:
  claude-network:
    driver: bridge
    # Isolated network for codehornets-ai activation system
    # Prevents conflicts with other Docker projects

# Usage:
#
# 1. Start system:
#    docker-compose -f core/docker-compose-activated.yml up -d
#
# 2. Check worker status:
#    docker logs marie
#    # Should show: "ðŸ’¤ marie: Idle (0% CPU until task arrives)"
#
# 3. Send task to Marie:
#    cat > core/shared/tasks/marie/test-001.json <<EOF
#    {
#      "task_id": "test-001",
#      "description": "Evaluate intermediate dance students"
#    }
#    EOF
#    # Marie wakes up INSTANTLY (<1ms) and processes task
#
# 4. Check result:
#    cat core/shared/results/marie/test-001.json
#
# 5. Monitor heartbeats:
#    watch -n 1 cat core/shared/heartbeats/marie.json
#
# 6. Switch to Redis mode (for production):
#    docker-compose -f core/docker-compose-activated.yml down
#    # Edit environment: ACTIVATION_MODE=redis
#    docker-compose -f core/docker-compose-activated.yml up -d
#
# Performance:
#   - inotify: <1ms wakeup latency, 0% CPU when idle
#   - redis: <10ms wakeup latency, 0% CPU when idle, clusterable
