import{r as l,j as e}from"./ui-vendor-DaEk3EBW.js";import{al as ve,am as Oe,V as Se,an as Ae,ao as Re,H as ke,ap as _e,aq as se,$ as Ce,ar as be,P as te,B as u,ai as ne,Y as ae,M as $e,as as re,W as Ve,ab as Fe,A as oe,m as ie,ah as le,ag as ce,at as Me,au as Te,a as x,av as Ee,aw as Le}from"./index-CJH4p4E4.js";import{l as A}from"./tauri-KcdjxZBy.js";import{M as ue,R as de}from"./rotate-ccw-cfI096PE.js";import"./react-vendor-CWc6w16D.js";import"./syntax-vendor-B5APtO4k.js";import"./editor-vendor-CFSDMwtX.js";import"./utils-C7WoKIg-.js";function qe({agentRunId:R,tabId:y,className:me}){var Q,X,Z;const{updateTabTitle:F,updateTabStatus:j}=ve(),[t,pe]=l.useState(null),[d,g]=l.useState([]),[fe,w]=l.useState([]),[ge,N]=l.useState(!0),[p,M]=l.useState(!1),[h,T]=l.useState(!1),[k,m]=l.useState(null),[he,_]=l.useState(!1),[C,xe]=l.useState(!1),E=l.useRef(!0),v=l.useRef(!1),L=l.useRef(null),U=l.useRef(null),z=l.useRef(null),J=l.useRef(null),f=l.useRef([]),{getCachedOutput:D,setCachedOutput:B}=Oe(),ye=()=>{const s=p?z.current:L.current;if(s){const{scrollTop:a,scrollHeight:i,clientHeight:c}=s;return i-a-c<1}return!0},we=()=>{if(!C){const s=p?J.current:U.current;s&&s.scrollIntoView({behavior:"smooth"})}};l.useEffect(()=>{R&&(async()=>{try{N(!0);const a=await x.getAgentRun(parseInt(R));pe(a),F(y,`Agent: ${a.agent_name||"Unknown"}`),j(y,a.status==="running"?"running":a.status==="failed"?"error":"complete")}catch(a){console.error("Failed to load agent run:",a),j(y,"error")}finally{N(!1)}})()},[R,y,F,j]),l.useEffect(()=>()=>{f.current.forEach(s=>s()),f.current=[],v.current=!1},[]),l.useEffect(()=>{(!C||ye())&&we()},[d,C,p]);const b=async(s=!1)=>{if(t!=null&&t.id){console.log("[AgentRunOutputViewer] Loading output for run:",{runId:t.id,status:t.status,sessionId:t.session_id,skipCache:s});try{if(!s){const r=D(t.id);if(r){console.log("[AgentRunOutputViewer] Found cached output");const n=r.output.split(`
`).filter(o=>o.trim());if(w(n),g(r.messages),Date.now()-r.lastUpdated<5e3&&t.status!=="running"){console.log("[AgentRunOutputViewer] Using recent cache, skipping refresh");return}}}if(N(!0),t.session_id&&t.session_id!==""){console.log("[AgentRunOutputViewer] Attempting to load from JSONL with session_id:",t.session_id);try{const r=await x.loadAgentSessionHistory(t.session_id);console.log("[AgentRunOutputViewer] Successfully loaded JSONL history:",r.length,"messages");const n=r.map(o=>({...o,type:o.type||"assistant"}));if(g(n),w(r.map(o=>JSON.stringify(o))),B(t.id,{output:r.map(o=>JSON.stringify(o)).join(`
`),messages:n,lastUpdated:Date.now(),status:t.status}),t.status==="running"){console.log("[AgentRunOutputViewer] Setting up live listeners for running session"),H();try{await x.streamSessionOutput(t.id)}catch(o){console.warn("[AgentRunOutputViewer] Failed to start streaming, will poll instead:",o)}}return}catch(r){console.warn("[AgentRunOutputViewer] Failed to load from JSONL:",r),console.warn("[AgentRunOutputViewer] Falling back to regular output method")}}else console.log("[AgentRunOutputViewer] No session_id available, using fallback method");console.log("[AgentRunOutputViewer] Using getSessionOutput fallback");const a=await x.getSessionOutput(t.id);console.log("[AgentRunOutputViewer] Received raw output:",a.length,"characters");const i=a.split(`
`).filter(r=>r.trim());w(i);const c=[];for(const r of i)try{const n=JSON.parse(r);c.push(n)}catch(n){console.error("[AgentRunOutputViewer] Failed to parse message:",n,r)}if(console.log("[AgentRunOutputViewer] Parsed",c.length,"messages from output"),g(c),B(t.id,{output:a,messages:c,lastUpdated:Date.now(),status:t.status}),t.status==="running"){console.log("[AgentRunOutputViewer] Setting up live listeners for running session (fallback)"),H();try{await x.streamSessionOutput(t.id)}catch(r){console.warn("[AgentRunOutputViewer] Failed to start streaming (fallback), will poll instead:",r)}}}catch(a){console.error("Failed to load agent output:",a),m({message:"Failed to load agent output",type:"error"})}finally{N(!1)}}},H=async()=>{if(!(!(t!=null&&t.id)||v.current))try{f.current.forEach(r=>r()),f.current=[],v.current=!0,setTimeout(()=>{E.current=!1},100);const s=await A(`agent-output:${t.id}`,r=>{try{if(E.current){console.log("[AgentRunOutputViewer] Skipping message during initial load");return}w(o=>[...o,r.payload]);const n=JSON.parse(r.payload);g(o=>[...o,n])}catch(n){console.error("[AgentRunOutputViewer] Failed to parse message:",n,r.payload)}}),a=await A(`agent-error:${t.id}`,r=>{console.error("[AgentRunOutputViewer] Agent error:",r.payload),m({message:r.payload,type:"error"})}),i=await A(`agent-complete:${t.id}`,()=>{m({message:"Agent execution completed",type:"success"})}),c=await A(`agent-cancelled:${t.id}`,()=>{m({message:"Agent execution was cancelled",type:"error"})});f.current=[s,a,i,c]}catch(s){console.error("[AgentRunOutputViewer] Failed to set up live event listeners:",s)}},I=async()=>{const s=fe.join(`
`);await navigator.clipboard.writeText(s),_(!1),m({message:"Output copied as JSONL",type:"success"})},W=async()=>{var a,i,c,r;if(!t)return;let s=`# Agent Execution: ${t.agent_name}

`;s+=`**Task:** ${t.task}
`,s+=`**Model:** ${t.model==="opus"?"Claude 4 Opus":"Claude 4 Sonnet"}
`,s+=`**Date:** ${se(t.created_at)}
`,(a=t.metrics)!=null&&a.duration_ms&&(s+=`**Duration:** ${(t.metrics.duration_ms/1e3).toFixed(2)}s
`),(i=t.metrics)!=null&&i.total_tokens&&(s+=`**Total Tokens:** ${t.metrics.total_tokens}
`),(c=t.metrics)!=null&&c.cost_usd&&(s+=`**Cost:** $${t.metrics.cost_usd.toFixed(4)} USD
`),s+=`
---

`;for(const n of d)if(n.type==="system"&&n.subtype==="init")s+=`## System Initialization

`,s+=`- Session ID: \`${n.session_id||"N/A"}\`
`,s+=`- Model: \`${n.model||"default"}\`
`,n.cwd&&(s+=`- Working Directory: \`${n.cwd}\`
`),(r=n.tools)!=null&&r.length&&(s+=`- Tools: ${n.tools.join(", ")}
`),s+=`
`;else if(n.type==="assistant"&&n.message){s+=`## Assistant

`;for(const o of n.message.content||[])o.type==="text"?s+=`${o.text}

`:o.type==="tool_use"&&(s+=`### Tool: ${o.name}

`,s+=`\`\`\`json
${JSON.stringify(o.input,null,2)}
\`\`\`

`);n.message.usage&&(s+=`*Tokens: ${n.message.usage.input_tokens} in, ${n.message.usage.output_tokens} out*

`)}else if(n.type==="user"&&n.message){s+=`## User

`;for(const o of n.message.content||[])o.type==="text"?s+=`${o.text}

`:o.type==="tool_result"&&(s+=`### Tool Result

`,s+=`\`\`\`
${o.content}
\`\`\`

`)}else n.type==="result"&&(s+=`## Execution Result

`,n.result&&(s+=`${n.result}

`),n.error&&(s+=`**Error:** ${n.error}

`));await navigator.clipboard.writeText(s),_(!1),m({message:"Output copied as Markdown",type:"success"})},P=async()=>{T(!0),await b(),T(!1)},q=async()=>{if(!(t!=null&&t.id)){console.error("[AgentRunOutputViewer] No run ID available to stop");return}try{if(await x.killAgentSession(t.id)){console.log(`[AgentRunOutputViewer] Successfully stopped agent session ${t.id}`),m({message:"Agent execution stopped",type:"success"}),f.current.forEach(i=>i()),f.current=[],v.current=!1;const a={type:"result",subtype:"error",is_error:!0,result:"Execution stopped by user",duration_ms:0,usage:{input_tokens:0,output_tokens:0}};g(i=>[...i,a]),j(y,"idle"),await b(!0)}else console.warn(`[AgentRunOutputViewer] Failed to stop agent session ${t.id} - it may have already finished`),m({message:"Failed to stop agent - it may have already finished",type:"error"})}catch(s){console.error("[AgentRunOutputViewer] Failed to stop agent:",s),m({message:`Failed to stop execution: ${s instanceof Error?s.message:"Unknown error"}`,type:"error"})}},G=s=>{const a=s.currentTarget,{scrollTop:i,scrollHeight:c,clientHeight:r}=a,n=c-i-r;xe(n>50)};l.useEffect(()=>{if(!(t!=null&&t.id))return;const s=D(t.id);if(s){const a=s.output.split(`
`).filter(i=>i.trim());w(a),g(s.messages)}b()},[t==null?void 0:t.id]);const Y=l.useMemo(()=>d.filter(s=>{var a,i,c;if(s.isMeta&&!s.leafUuid&&!s.summary)return!1;if(s.type==="user"&&s.message){if(s.isMeta)return!1;const r=s.message;if(!r.content||Array.isArray(r.content)&&r.content.length===0)return!1;if(Array.isArray(r.content)){let n=!1;for(const o of r.content){if(o.type==="text"){n=!0;break}if(o.type==="tool_result"){let ee=!1;if(o.tool_use_id)for(let $=d.indexOf(s)-1;$>=0;$--){const O=d[$];if(O.type==="assistant"&&((a=O.message)!=null&&a.content)&&Array.isArray(O.message.content)){const V=O.message.content.find(S=>S.type==="tool_use"&&S.id===o.tool_use_id);if(V){const S=(i=V.name)==null?void 0:i.toLowerCase();(["task","edit","multiedit","todowrite","ls","read","glob","bash","write","grep"].includes(S)||(c=V.name)!=null&&c.startsWith("mcp__"))&&(ee=!0);break}}}if(!ee){n=!0;break}}}if(!n)return!1}}return!0}),[d]),K=s=>{const a=Ee[s]||Le;return e.jsx(a,{className:"h-5 w-5"})},je=s=>{if(!s)return"N/A";const a=Math.floor(s/1e3);if(a<60)return`${a}s`;const i=Math.floor(a/60),c=a%60;return`${i}m ${c}s`},Ne=s=>s?s>=1e3?`${(s/1e3).toFixed(1)}k`:s.toString():"0";return t?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:`h-full flex flex-col ${me||""}`,children:e.jsxs(Se,{className:"h-full flex flex-col",children:[e.jsx(Ae,{className:"pb-3",children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex items-start gap-3 flex-1 min-w-0",children:[e.jsx("div",{className:"mt-0.5",children:K(t.agent_icon)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs(Re,{className:"text-lg flex items-center gap-2",children:[t.agent_name,t.status==="running"&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),e.jsx("span",{className:"text-xs text-green-600 font-medium",children:"Running"})]})]}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1 truncate",children:t.task}),e.jsxs("div",{className:"flex items-center gap-3 text-xs text-muted-foreground mt-2",children:[e.jsx(ke,{variant:"outline",className:"text-xs",children:t.model==="opus"?"Claude 4 Opus":"Claude 4 Sonnet"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(_e,{className:"h-3 w-3"}),e.jsx("span",{children:se(t.created_at)})]}),((Q=t.metrics)==null?void 0:Q.duration_ms)&&e.jsx("span",{children:je(t.metrics.duration_ms)}),((X=t.metrics)==null?void 0:X.total_tokens)&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ce,{className:"h-3 w-3"}),e.jsx("span",{children:Ne(t.metrics.total_tokens)})]}),((Z=t.metrics)==null?void 0:Z.cost_usd)&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(be,{className:"h-3 w-3"}),e.jsxs("span",{children:["$",t.metrics.cost_usd.toFixed(4)]})]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(te,{trigger:e.jsxs(u,{variant:"ghost",size:"sm",className:"h-8 px-2",children:[e.jsx(ne,{className:"h-4 w-4 mr-1"}),"Copy",e.jsx(ae,{className:"h-3 w-3 ml-1"})]}),content:e.jsxs("div",{className:"w-44 p-1",children:[e.jsx(u,{variant:"ghost",size:"sm",className:"w-full justify-start",onClick:I,children:"Copy as JSONL"}),e.jsx(u,{variant:"ghost",size:"sm",className:"w-full justify-start",onClick:W,children:"Copy as Markdown"})]}),open:he,onOpenChange:_,align:"end"}),e.jsx(u,{variant:"ghost",size:"sm",onClick:()=>M(!p),title:p?"Exit fullscreen":"Enter fullscreen",className:"h-8 px-2",children:p?e.jsx(ue,{className:"h-4 w-4"}):e.jsx($e,{className:"h-4 w-4"})}),e.jsx(u,{variant:"ghost",size:"sm",onClick:P,disabled:h,title:"Refresh output",className:"h-8 px-2",children:e.jsx(de,{className:`h-4 w-4 ${h?"animate-spin":""}`})}),t.status==="running"&&e.jsx(u,{variant:"ghost",size:"sm",onClick:q,disabled:h,title:"Stop execution",className:"h-8 px-2 text-destructive hover:text-destructive",children:e.jsx(re,{className:"h-4 w-4"})})]})]})}),e.jsx(Ve,{className:`${p?"h-[calc(100vh-120px)]":"flex-1"} p-0 overflow-hidden`,children:ge?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Fe,{className:"h-4 w-4 animate-spin"}),e.jsx("span",{children:"Loading output..."})]})}):d.length===0?e.jsx("div",{className:"flex items-center justify-center h-full text-muted-foreground",children:e.jsx("p",{children:"No output available yet"})}):e.jsxs("div",{ref:L,className:"h-full overflow-y-auto p-4 space-y-2",onScroll:G,children:[e.jsx(oe,{children:Y.map((s,a)=>e.jsx(ie.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.2},children:e.jsx(le,{children:e.jsx(ce,{message:s,streamMessages:d})})},a))}),e.jsx("div",{ref:U})]})})]})}),p&&e.jsxs("div",{className:"fixed inset-0 bg-background z-[60] flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[K(t.agent_icon),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-lg",children:t.agent_name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:t.task})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(te,{trigger:e.jsxs(u,{variant:"outline",size:"sm",children:[e.jsx(ne,{className:"h-4 w-4 mr-2"}),"Copy Output",e.jsx(ae,{className:"h-3 w-3 ml-2"})]}),content:e.jsxs("div",{className:"w-44 p-1",children:[e.jsx(u,{variant:"ghost",size:"sm",className:"w-full justify-start",onClick:I,children:"Copy as JSONL"}),e.jsx(u,{variant:"ghost",size:"sm",className:"w-full justify-start",onClick:W,children:"Copy as Markdown"})]}),align:"end"}),e.jsx(u,{variant:"outline",size:"sm",onClick:P,disabled:h,children:e.jsx(de,{className:`h-4 w-4 ${h?"animate-spin":""}`})}),t.status==="running"&&e.jsxs(u,{variant:"outline",size:"sm",onClick:q,disabled:h,children:[e.jsx(re,{className:"h-4 w-4 mr-2"}),"Stop"]}),e.jsxs(u,{variant:"outline",size:"sm",onClick:()=>M(!1),children:[e.jsx(ue,{className:"h-4 w-4 mr-2"}),"Exit Fullscreen"]})]})]}),e.jsx("div",{ref:z,className:"flex-1 overflow-y-auto p-6",onScroll:G,children:e.jsx("div",{className:"max-w-4xl mx-auto space-y-2",children:d.length===0?e.jsx("div",{className:"text-center text-muted-foreground py-8",children:"No output available yet"}):e.jsxs(e.Fragment,{children:[e.jsx(oe,{children:Y.map((s,a)=>e.jsx(ie.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.2},children:e.jsx(le,{children:e.jsx(ce,{message:s,streamMessages:d})})},a))}),e.jsx("div",{ref:J})]})})})]}),e.jsx(Me,{children:k&&e.jsx(Te,{message:k.message,type:k.type,onDismiss:()=>m(null)})})]}):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading agent run..."})]})})}export{qe as AgentRunOutputViewer,qe as default};
