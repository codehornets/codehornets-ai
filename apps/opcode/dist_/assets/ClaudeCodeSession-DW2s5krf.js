import{r as s,j as e,R as bt}from"./ui-vendor-DaEk3EBW.js";import{c as kt,u as xs,a as ue,m as U,b as G,C as Mt,B as E,X as dt,T as fs,d as ps,e as Jt,f as et,S as gs,U as js,g as zt,h as vs,F as ts,Z as Pt,i as ys,G as It,A as Ae,M as Ot,D as Ze,j as Ye,k as ut,l as ss,n as $e,o as Vt,P as ct,p as _t,q as Et,r as Tt,s as Qt,t as yt,v as ws,w as Ns,x as bs,L as ks,y as Cs,z as Ss,R as _s,E as ns,H as Dt,I as as,J as wt,K as Nt,N as Qe,O as Ct,Q as $t,V as Xe,W as xt,Y as At,_ as Es,$ as rs,a0 as pt,a1 as gt,a2 as jt,a3 as vt,a4 as os,a5 as Ts,a6 as Ds,a7 as Lt,a8 as Fs,a9 as Rs,aa as Ms,ab as Ps,ac as Is,ad as $s,ae as As,af as Ls,ag as zs,ah as Os,ai as Us,aj as Ws,ak as Xt}from"./index-CJH4p4E4.js";import{c as Hs}from"./tauri-KcdjxZBy.js";import{M as is,R as qs}from"./rotate-ccw-cfI096PE.js";import{f as Bs}from"./utils-C7WoKIg-.js";import"./react-vendor-CWc6w16D.js";import"./syntax-vendor-B5APtO4k.js";import"./editor-vendor-CFSDMwtX.js";/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Zt=kt("ArrowRight",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Gs=kt("Building2",[["path",{d:"M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z",key:"1b4qmf"}],["path",{d:"M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2",key:"i71pzd"}],["path",{d:"M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2",key:"10jefs"}],["path",{d:"M10 6h4",key:"1itunk"}],["path",{d:"M10 10h4",key:"tcdvrf"}],["path",{d:"M10 14h4",key:"kelpxr"}],["path",{d:"M10 18h4",key:"1ulq68"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ks=kt("Diff",[["path",{d:"M12 3v14",key:"7cf3v8"}],["path",{d:"M5 10h14",key:"elsbfy"}],["path",{d:"M5 21h14",key:"11awu3"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Js=kt("GitFork",[["circle",{cx:"12",cy:"18",r:"3",key:"1mpf1b"}],["circle",{cx:"6",cy:"6",r:"3",key:"1lh9wr"}],["circle",{cx:"18",cy:"6",r:"3",key:"1h7g24"}],["path",{d:"M18 9v2c0 .6-.4 1-1 1H7c-.6 0-1-.4-1-1V9",key:"1uq4wg"}],["path",{d:"M12 12v3",key:"158kv8"}]]),Ft=i=>i.has_bash_commands?vs:i.has_file_references?ts:i.accepts_arguments?Pt:i.scope==="project"?ys:i.scope==="user"?It:Mt,Vs=({projectPath:i,onSelect:A,onClose:N,initialQuery:k="",className:C})=>{const[f,p]=s.useState([]),[b,H]=s.useState([]),[r,L]=s.useState(!0),[m,V]=s.useState(null),[c,T]=s.useState(0),[D,ee]=s.useState(k),[B,Z]=s.useState("custom"),M=s.useRef(null),q=zt(),J=xs("slash_commands");s.useEffect(()=>{z()},[i]),s.useEffect(()=>{if(!f.length){H([]);return}const a=D.toLowerCase();let j;B==="default"?j=f.filter(F=>F.scope==="default"):j=f.filter(F=>F.scope!=="default");let x;a?(x=j.filter(F=>!!(F.name.toLowerCase().includes(a)||F.full_command.toLowerCase().includes(a)||F.namespace&&F.namespace.toLowerCase().includes(a)||F.description&&F.description.toLowerCase().includes(a))),x.sort((F,P)=>{const le=F.name.toLowerCase()===a,te=P.name.toLowerCase()===a;if(le&&!te)return-1;if(!le&&te)return 1;const Te=F.name.toLowerCase().startsWith(a),De=P.name.toLowerCase().startsWith(a);return Te&&!De?-1:!Te&&De?1:F.name.localeCompare(P.name)})):x=j,H(x),T(0)},[D,f,B]),s.useEffect(()=>{const a=j=>{switch(j.key){case"Escape":j.preventDefault(),N();break;case"Enter":if(j.preventDefault(),b.length>0&&c<b.length){const x=b[c];q.slashCommandSelected({command_name:x.name,selection_method:"keyboard"}),J.trackUsage(),A(x)}break;case"ArrowUp":j.preventDefault(),T(x=>Math.max(0,x-1));break;case"ArrowDown":j.preventDefault(),T(x=>Math.min(b.length-1,x+1));break}};return window.addEventListener("keydown",a),()=>window.removeEventListener("keydown",a)},[b,c,A,N]),s.useEffect(()=>{if(M.current){const a=M.current.querySelector(`[data-index="${c}"]`);a&&a.scrollIntoView({block:"nearest",behavior:"smooth"})}},[c]);const z=async()=>{try{L(!0),V(null);const a=await ue.slashCommandsList(i);p(a)}catch(a){console.error("Failed to load slash commands:",a),V(a instanceof Error?a.message:"Failed to load commands"),p([])}finally{L(!1)}},Y=a=>{q.slashCommandSelected({command_name:a.name,selection_method:"click"}),J.trackUsage(),A(a)},h=b.reduce((a,j)=>{let x;return j.scope==="user"?x=j.namespace?`User Commands: ${j.namespace}`:"User Commands":j.scope==="project"?x=j.namespace?`Project Commands: ${j.namespace}`:"Project Commands":x=j.namespace||"Commands",a[x]||(a[x]=[]),a[x].push(j),a},{});return s.useEffect(()=>{ee(k)},[k]),e.jsxs(U.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},className:G("absolute bottom-full mb-2 left-0 z-50","w-[600px] h-[400px]","bg-background border border-border rounded-lg shadow-lg","flex flex-col overflow-hidden",C),children:[e.jsxs("div",{className:"border-b border-border p-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Mt,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm font-medium",children:"Slash Commands"}),D&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:['Searching: "',D,'"']})]}),e.jsx(E,{variant:"ghost",size:"icon",onClick:N,className:"h-8 w-8",children:e.jsx(dt,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"mt-3",children:e.jsx(fs,{value:B,onValueChange:Z,children:e.jsxs(ps,{className:"grid w-full grid-cols-2",children:[e.jsx(Jt,{value:"default",children:"Default"}),e.jsx(Jt,{value:"custom",children:"Custom"})]})})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto relative",children:[r&&e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx("span",{className:"text-sm text-muted-foreground",children:"Loading commands..."})}),m&&e.jsxs("div",{className:"flex flex-col items-center justify-center h-full p-4",children:[e.jsx(et,{className:"h-8 w-8 text-destructive mb-2"}),e.jsx("span",{className:"text-sm text-destructive text-center",children:m})]}),!r&&!m&&e.jsxs(e.Fragment,{children:[B==="default"&&e.jsxs(e.Fragment,{children:[b.length===0&&e.jsxs("div",{className:"flex flex-col items-center justify-center h-full",children:[e.jsx(Mt,{className:"h-8 w-8 text-muted-foreground mb-2"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:D?"No commands found":"No default commands available"}),!D&&e.jsx("p",{className:"text-xs text-muted-foreground mt-2 text-center px-4",children:"Default commands are built-in system commands"})]}),b.length>0&&e.jsx("div",{className:"p-2",ref:M,children:e.jsx("div",{className:"space-y-0.5",children:b.map((a,j)=>{const x=Ft(a),F=j===c;return e.jsxs("button",{"data-index":j,onClick:()=>Y(a),onMouseEnter:()=>T(j),className:G("w-full flex items-start gap-3 px-3 py-2 rounded-md","hover:bg-accent transition-colors","text-left",F&&"bg-accent"),children:[e.jsx(x,{className:"h-4 w-4 text-muted-foreground mt-1 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 overflow-hidden",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:a.full_command}),e.jsx("span",{className:"text-xs text-muted-foreground px-1.5 py-0.5 bg-muted rounded",children:a.scope})]}),a.description&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1 leading-relaxed",children:a.description})]})]},a.id)})})})]}),B==="custom"&&e.jsxs(e.Fragment,{children:[b.length===0&&e.jsxs("div",{className:"flex flex-col items-center justify-center h-full",children:[e.jsx(gs,{className:"h-8 w-8 text-muted-foreground mb-2"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:D?"No commands found":"No custom commands available"}),!D&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-2 text-center px-4",children:["Create commands in ",e.jsx("code",{className:"px-1",children:".claude/commands/"})," or ",e.jsx("code",{className:"px-1",children:"~/.claude/commands/"})]})]}),b.length>0&&e.jsx("div",{className:"p-2",ref:M,children:Object.keys(h).length===1?e.jsx("div",{className:"space-y-0.5",children:b.map((a,j)=>{const x=Ft(a),F=j===c;return e.jsxs("button",{"data-index":j,onClick:()=>Y(a),onMouseEnter:()=>T(j),className:G("w-full flex items-start gap-3 px-3 py-2 rounded-md","hover:bg-accent transition-colors","text-left",F&&"bg-accent"),children:[e.jsx(x,{className:"h-4 w-4 mt-0.5 flex-shrink-0 text-muted-foreground"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-baseline gap-2",children:[e.jsx("span",{className:"font-mono text-sm text-primary",children:a.full_command}),a.accepts_arguments&&e.jsx("span",{className:"text-xs text-muted-foreground",children:"[args]"})]}),a.description&&e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5 truncate",children:a.description}),e.jsxs("div",{className:"flex items-center gap-3 mt-1",children:[a.allowed_tools.length>0&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:[a.allowed_tools.length," tool",a.allowed_tools.length===1?"":"s"]}),a.has_bash_commands&&e.jsx("span",{className:"text-xs text-blue-600 dark:text-blue-400",children:"Bash"}),a.has_file_references&&e.jsx("span",{className:"text-xs text-green-600 dark:text-green-400",children:"Files"})]})]})]},a.id)})}):e.jsx("div",{className:"space-y-4",children:Object.entries(h).map(([a,j])=>e.jsxs("div",{children:[e.jsxs("h3",{className:"text-xs font-medium text-muted-foreground uppercase tracking-wider px-3 mb-1 flex items-center gap-2",children:[a.startsWith("User Commands")&&e.jsx(js,{className:"h-3 w-3"}),a.startsWith("Project Commands")&&e.jsx(Gs,{className:"h-3 w-3"}),a]}),e.jsx("div",{className:"space-y-0.5",children:j.map(x=>{const F=Ft(x),P=b.indexOf(x),le=P===c;return e.jsxs("button",{"data-index":P,onClick:()=>Y(x),onMouseEnter:()=>T(P),className:G("w-full flex items-start gap-3 px-3 py-2 rounded-md","hover:bg-accent transition-colors","text-left",le&&"bg-accent"),children:[e.jsx(F,{className:"h-4 w-4 mt-0.5 flex-shrink-0 text-muted-foreground"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-baseline gap-2",children:[e.jsx("span",{className:"font-mono text-sm text-primary",children:x.full_command}),x.accepts_arguments&&e.jsx("span",{className:"text-xs text-muted-foreground",children:"[args]"})]}),x.description&&e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5 truncate",children:x.description}),e.jsxs("div",{className:"flex items-center gap-3 mt-1",children:[x.allowed_tools.length>0&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:[x.allowed_tools.length," tool",x.allowed_tools.length===1?"":"s"]}),x.has_bash_commands&&e.jsx("span",{className:"text-xs text-blue-600 dark:text-blue-400",children:"Bash"}),x.has_file_references&&e.jsx("span",{className:"text-xs text-green-600 dark:text-green-400",children:"Files"})]})]})]},x.id)})})]},a))})})]})]})]}),e.jsx("div",{className:"border-t border-border p-2",children:e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:"↑↓ Navigate • Enter Select • Esc Close"})})]})},Yt=({images:i,onRemove:A,className:N})=>{const[k,C]=s.useState(null),[f,p]=s.useState(null),[b,H]=s.useState(new Set),r=i.slice(0,10),L=c=>{H(T=>new Set(T).add(c))},m=(c,T)=>{c.stopPropagation(),A(T)},V=c=>c.startsWith("data:")?c:Hs(c);return r.length===0?null:e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:G("flex gap-2 p-2 overflow-x-auto",N),children:[e.jsx(Ae,{children:r.map((c,T)=>e.jsxs(U.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},transition:{duration:.2},className:"relative flex-shrink-0 group",onMouseEnter:()=>p(T),onMouseLeave:()=>p(null),children:[e.jsxs("div",{className:"relative w-16 h-16 rounded-md overflow-hidden border border-border cursor-pointer hover:border-primary transition-colors",onClick:()=>C(T),children:[b.has(T)?e.jsx("div",{className:"w-full h-full bg-muted flex items-center justify-center",children:e.jsx("span",{className:"text-xs text-muted-foreground",children:"Error"})}):e.jsx("img",{src:V(c),alt:`Preview ${T+1}`,className:"w-full h-full object-cover",onError:()=>L(T)}),e.jsx("div",{className:"absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center",children:e.jsx(Ot,{className:"h-4 w-4 text-white"})})]}),e.jsx(Ae,{children:f===T&&e.jsx(U.button,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},className:"absolute -top-1 -right-1 w-5 h-5 bg-destructive text-destructive-foreground rounded-full flex items-center justify-center hover:bg-destructive/90 transition-colors",onClick:D=>m(D,T),children:e.jsx(dt,{className:"h-3 w-3"})})})]},`${c}-${T}`))}),i.length>10&&e.jsx("div",{className:"flex-shrink-0 w-16 h-16 rounded-md border border-border bg-muted flex items-center justify-center",children:e.jsxs("span",{className:"text-xs text-muted-foreground",children:["+",i.length-10]})})]}),e.jsx(Ze,{open:k!==null,onOpenChange:c=>!c&&C(null),children:e.jsxs(Ye,{className:"max-w-4xl max-h-[90vh] p-0",children:[e.jsx(ut,{className:"sr-only",children:"Image Preview"}),k!==null&&e.jsxs("div",{className:"relative w-full h-full flex items-center justify-center p-4",children:[e.jsx("img",{src:V(r[k]),alt:`Full preview ${k+1}`,className:"max-w-full max-h-full object-contain",onError:()=>L(k)}),r.length>1&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"absolute left-4 top-1/2 -translate-y-1/2 w-10 h-10 bg-black/50 text-white rounded-full flex items-center justify-center hover:bg-black/70 transition-colors",onClick:()=>C(c=>c!==null?(c-1+r.length)%r.length:0),children:"←"}),e.jsx("button",{className:"absolute right-4 top-1/2 -translate-y-1/2 w-10 h-10 bg-black/50 text-white rounded-full flex items-center justify-center hover:bg-black/70 transition-colors",onClick:()=>C(c=>c!==null?(c+1)%r.length:0),children:"→"})]})]})]})})]})};let ls;try{typeof window<"u"&&window.__TAURI__&&(ls=require("@tauri-apps/api/webviewWindow").getCurrentWebviewWindow)}catch{console.log("[FloatingPromptInput] Tauri webview API not available, using web mode")}const Qs=ls||(()=>({listen:()=>Promise.resolve(()=>{})})),ke=[{id:"auto",name:"Auto",description:"Let Claude decide",level:0,icon:e.jsx(bs,{className:"h-3.5 w-3.5"}),color:"text-muted-foreground",shortName:"A"},{id:"think",name:"Think",description:"Basic reasoning",level:1,phrase:"think",icon:e.jsx(ks,{className:"h-3.5 w-3.5"}),color:"text-primary",shortName:"T"},{id:"think_hard",name:"Think Hard",description:"Deeper analysis",level:2,phrase:"think hard",icon:e.jsx(Cs,{className:"h-3.5 w-3.5"}),color:"text-primary",shortName:"T+"},{id:"think_harder",name:"Think Harder",description:"Extensive reasoning",level:3,phrase:"think harder",icon:e.jsx(Ss,{className:"h-3.5 w-3.5"}),color:"text-primary",shortName:"T++"},{id:"ultrathink",name:"Ultrathink",description:"Maximum computation",level:4,phrase:"ultrathink",icon:e.jsx(_s,{className:"h-3.5 w-3.5"}),color:"text-primary",shortName:"Ultra"}],Rt=({level:i,color:A})=>{const N=k=>k>i?"bg-muted":"bg-primary";return e.jsx("div",{className:"flex items-center gap-0.5",children:[1,2,3,4].map(k=>e.jsx("div",{className:G("w-1 h-3 rounded-full transition-all duration-200",N(k),k<=i&&"shadow-sm")},k))})},ft=[{id:"sonnet",name:"Claude 4 Sonnet",description:"Faster, efficient for most tasks",icon:e.jsx(Pt,{className:"h-3.5 w-3.5"}),shortName:"S",color:"text-primary"},{id:"opus",name:"Claude 4 Opus",description:"More capable, better for complex tasks",icon:e.jsx(Pt,{className:"h-3.5 w-3.5"}),shortName:"O",color:"text-primary"}],Xs=({onSend:i,isLoading:A=!1,disabled:N=!1,defaultModel:k="sonnet",projectPath:C,className:f,onCancel:p,extraMenuItems:b},H)=>{var je,He,Je,se,X,Ne,ht,I,Ee,Me;const[r,L]=s.useState(""),[m,V]=s.useState(k),[c,T]=s.useState("auto"),[D,ee]=s.useState(!1),[B,Z]=s.useState(!1),[M,q]=s.useState(!1),[J,z]=s.useState(!1),[Y,h]=s.useState(""),[a,j]=s.useState(!1),[x,F]=s.useState(""),[P,le]=s.useState(0),[te,Te]=s.useState([]),[De,Ue]=s.useState(!1),Q=s.useRef(null),fe=s.useRef(null),Ce=s.useRef(null),[pe,Fe]=s.useState(48),Re=s.useRef(!1);bt.useImperativeHandle(H,()=>({addImage:t=>{L(d=>{if(O(d).includes(t))return d;const w=t.includes(" ")?`@"${t}"`:`@${t}`,y=d+(d.endsWith(" ")||d===""?"":" ")+w+" ";return setTimeout(()=>{const $=D?fe.current:Q.current;$==null||$.focus(),$==null||$.setSelectionRange(y.length,y.length)},0),y})}}),[D]);const o=t=>{var g;if(t.startsWith("data:image/"))return!0;const d=(g=t.split(".").pop())==null?void 0:g.toLowerCase();return["png","jpg","jpeg","gif","svg","webp","ico","bmp"].includes(d||"")},O=t=>{console.log("[extractImagePaths] Input text length:",t.length);const d=/@"([^"]+)"/g,g=/@([^@\n\s]+)/g,w=new Set;let y=Array.from(t.matchAll(d));console.log("[extractImagePaths] Quoted matches:",y.length);for(const K of y){const re=K[1];console.log("[extractImagePaths] Processing quoted path:",re.startsWith("data:")?"data URL":re);const ye=re.startsWith("data:")||re.startsWith("/")?re:C?`${C}/${re}`:re;o(ye)&&w.add(ye)}let $=t.replace(d,"");y=Array.from($.matchAll(g)),console.log("[extractImagePaths] Unquoted matches:",y.length);for(const K of y){const re=K[1].trim();if(re.includes("data:"))continue;console.log("[extractImagePaths] Processing unquoted path:",re);const ye=re.startsWith("/")?re:C?`${C}/${re}`:re;o(ye)&&w.add(ye)}const ae=Array.from(w);return console.log("[extractImagePaths] Final extracted paths (unique):",ae.length),ae};s.useEffect(()=>{console.log("[useEffect] Prompt changed:",r);const t=O(r);if(console.log("[useEffect] Setting embeddedImages to:",t),Te(t),Q.current&&!D){Q.current.style.height="auto";const d=Q.current.scrollHeight,g=Math.min(Math.max(d,48),240);Fe(g),Q.current.style.height=`${g}px`}},[r,C,D]),s.useEffect(()=>{let t=0;return(async()=>{try{Ce.current&&Ce.current();const g=Qs();Ce.current=await g.onDragDropEvent(w=>{if(w.payload.type==="enter"||w.payload.type==="over")Ue(!0);else if(w.payload.type==="leave")Ue(!1);else if(w.payload.type==="drop"&&w.payload.paths){Ue(!1);const y=Date.now();if(y-t<200)return;t=y;const ae=w.payload.paths.filter(o);ae.length>0&&L(K=>{const re=O(K),ye=ae.filter(ve=>!re.includes(ve));if(ye.length===0)return K;const Pe=ye.map(ve=>ve.includes(" ")?`@"${ve}"`:`@${ve}`).join(" "),at=K+(K.endsWith(" ")||K===""?"":" ")+Pe+" ";return setTimeout(()=>{const ve=D?fe.current:Q.current;ve==null||ve.focus(),ve==null||ve.setSelectionRange(at.length,at.length)},0),at})}})}catch(g){console.error("Failed to set up Tauri drag-drop listener:",g)}})(),()=>{Ce.current&&(Ce.current(),Ce.current=null)}},[]),s.useEffect(()=>{D&&fe.current?fe.current.focus():!D&&Q.current&&Q.current.focus()},[D]);const ge=t=>{const d=t.target.value,g=t.target.selectionStart||0;if(Q.current&&!D){Q.current.style.height="auto";const w=Q.current.scrollHeight,y=Math.min(Math.max(w,48),240);Fe(y),Q.current.style.height=`${y}px`}if(d.length>r.length&&d[g-1]==="/"&&(g===1||g>1&&/\s/.test(d[g-2]))&&(console.log("[FloatingPromptInput] / detected for slash command"),j(!0),F(""),le(g)),C!=null&&C.trim()&&d.length>r.length&&d[g-1]==="@"&&(console.log("[FloatingPromptInput] @ detected, projectPath:",C),z(!0),h(""),le(g)),a&&g>=P){let w=-1;for(let y=g-1;y>=0;y--){if(d[y]==="/"){w=y;break}if(d[y]===" "||d[y]===`
`)break}if(w!==-1){const y=d.substring(w+1,g);F(y)}else j(!1),F("")}if(J&&g>=P){let w=-1;for(let y=g-1;y>=0;y--){if(d[y]==="@"){w=y;break}if(d[y]===" "||d[y]===`
`)break}if(w!==-1){const y=d.substring(w+1,g);h(y)}else z(!1),h("")}L(d),le(g)},Le=t=>{if(Q.current){let d=-1;for(let K=P-1;K>=0;K--){if(r[K]==="@"){d=K;break}if(r[K]===" "||r[K]===`
`)break}if(d===-1){console.error("[FloatingPromptInput] @ position not found");return}const g=Q.current,w=r.substring(0,d),y=r.substring(P),$=t.path.startsWith(C||"")?t.path.slice((C||"").length+1):t.path,ae=`${w}@${$} ${y}`;L(ae),z(!1),h(""),setTimeout(()=>{g.focus();const K=w.length+$.length+2;g.setSelectionRange(K,K)},0)}},ze=()=>{z(!1),h(""),setTimeout(()=>{var t;(t=Q.current)==null||t.focus()},0)},tt=t=>{const d=D?fe.current:Q.current;if(!d)return;let g=-1;for(let $=P-1;$>=0;$--){if(r[$]==="/"){g=$;break}if(r[$]===" "||r[$]===`
`)break}if(g===-1){console.error("[FloatingPromptInput] / position not found");return}const w=r.substring(0,g),y=r.substring(P);if(t.accepts_arguments){const $=`${w}${t.full_command} `;L($),j(!1),F(""),setTimeout(()=>{d.focus();const ae=w.length+t.full_command.length+1;d.setSelectionRange(ae,ae)},0)}else{const $=`${w}${t.full_command} ${y}`;L($),j(!1),F(""),setTimeout(()=>{d.focus();const ae=w.length+t.full_command.length+1;d.setSelectionRange(ae,ae)},0)}},Se=()=>{j(!1),F(""),setTimeout(()=>{const t=D?fe.current:Q.current;t==null||t.focus()},0)},We=()=>{Re.current=!0},st=()=>{setTimeout(()=>{Re.current=!1},0)},Ge=t=>{if(Re.current)return!0;if(!t)return!1;const d=t.nativeEvent;if(d.isComposing)return!0;const g=d.key;if(g==="Process"||g==="Unidentified")return!0;const w=d;return(w.keyCode??w.which)===229},nt=()=>{if(!Ge()&&r.trim()&&!N){let t=r.trim();const d=ke.find(g=>g.id===c);d&&d.phrase&&(t=`${t}.

${d.phrase}.`),i(t,m),L(""),Te([]),Fe(48)}},_e=t=>{if(J&&t.key==="Escape"){t.preventDefault(),z(!1),h("");return}if(a&&t.key==="Escape"){t.preventDefault(),j(!1),F("");return}if(t.key==="e"&&(t.ctrlKey||t.metaKey)&&t.shiftKey){t.preventDefault(),ee(!0);return}if(t.key==="Enter"&&!t.shiftKey&&!D&&!J&&!a){if(Ge(t))return;t.preventDefault(),nt()}},me=async t=>{var g;const d=(g=t.clipboardData)==null?void 0:g.items;if(d){for(const w of d)if(w.type.startsWith("image/")){t.preventDefault();const y=w.getAsFile();if(!y)continue;try{const $=new FileReader;$.onload=()=>{const ae=$.result;L(K=>{const re=`@"${ae}"`,ye=K+(K.endsWith(" ")||K===""?"":" ")+re+" ";return setTimeout(()=>{const Pe=D?fe.current:Q.current;Pe==null||Pe.focus(),Pe==null||Pe.setSelectionRange(ye.length,ye.length)},0),ye})},$.readAsDataURL(y)}catch($){console.error("Failed to paste image:",$)}}}},ce=t=>{t.preventDefault(),t.stopPropagation()},mt=t=>{t.preventDefault(),t.stopPropagation()},Ke=t=>{const d=te[t];if(d.startsWith("data:")){const ae=`@"${d}"`,K=r.replace(ae,"").trim();L(K);return}const g=d.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),w=d.replace(C+"/","").replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),y=[new RegExp(`@"${g}"\\s?`,"g"),new RegExp(`@${g}\\s?`,"g"),new RegExp(`@"${w}"\\s?`,"g"),new RegExp(`@${w}\\s?`,"g")];let $=r;for(const ae of y)$=$.replace(ae,"");L($.trim())},de=ft.find(t=>t.id===m)||ft[0];return e.jsx(ss,{children:e.jsxs(e.Fragment,{children:[e.jsx(Ae,{children:D&&e.jsx(U.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-background/80 backdrop-blur-sm",onClick:()=>ee(!1),children:e.jsxs(U.div,{initial:{opacity:0,y:8},animate:{opacity:1,y:0},exit:{opacity:0,y:-8},transition:{duration:.15},className:"bg-background border border-border rounded-lg shadow-lg w-full max-w-2xl p-4 space-y-4",onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-medium",children:"Compose your prompt"}),e.jsx($e,{content:"Minimize",side:"bottom",children:e.jsx(U.div,{whileTap:{scale:.97},transition:{duration:.15},children:e.jsx(E,{variant:"ghost",size:"icon",onClick:()=>ee(!1),className:"h-8 w-8",children:e.jsx(is,{className:"h-4 w-4"})})})})]}),te.length>0&&e.jsx(Yt,{images:te,onRemove:Ke,className:"border-t border-border pt-2"}),e.jsx(Vt,{ref:fe,value:r,onChange:ge,onCompositionStart:We,onCompositionEnd:st,onPaste:me,placeholder:"Type your message...",className:"min-h-[200px] resize-none",disabled:N,onDragEnter:ce,onDragLeave:ce,onDragOver:ce,onDrop:mt}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Model:"}),e.jsx(ct,{trigger:e.jsxs(E,{variant:"outline",size:"sm",onClick:()=>Z(!B),className:"gap-2",children:[e.jsx("span",{className:de.color,children:de.icon}),de.name]}),content:e.jsx("div",{className:"w-[300px] p-1",children:ft.map(t=>e.jsxs("button",{onClick:()=>{V(t.id),Z(!1)},className:G("w-full flex items-start gap-3 p-3 rounded-md transition-colors text-left","hover:bg-accent",m===t.id&&"bg-accent"),children:[e.jsx("div",{className:"mt-0.5",children:e.jsx("span",{className:t.color,children:t.icon})}),e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsx("div",{className:"font-medium text-sm",children:t.name}),e.jsx("div",{className:"text-xs text-muted-foreground",children:t.description})]})]},t.id))}),open:B,onOpenChange:Z,align:"start",side:"top"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Thinking:"}),e.jsx(ct,{trigger:e.jsxs(_t,{children:[e.jsx(Et,{asChild:!0,children:e.jsxs(E,{variant:"outline",size:"sm",onClick:()=>q(!M),className:"gap-2",children:[e.jsx("span",{className:(je=ke.find(t=>t.id===c))==null?void 0:je.color,children:(He=ke.find(t=>t.id===c))==null?void 0:He.icon}),e.jsx(Rt,{level:((Je=ke.find(t=>t.id===c))==null?void 0:Je.level)||0})]})}),e.jsxs(Tt,{children:[e.jsx("p",{className:"font-medium",children:((se=ke.find(t=>t.id===c))==null?void 0:se.name)||"Auto"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:(X=ke.find(t=>t.id===c))==null?void 0:X.description})]})]}),content:e.jsx("div",{className:"w-[280px] p-1",children:ke.map(t=>e.jsxs("button",{onClick:()=>{T(t.id),q(!1)},className:G("w-full flex items-start gap-3 p-3 rounded-md transition-colors text-left","hover:bg-accent",c===t.id&&"bg-accent"),children:[e.jsx("span",{className:G("mt-0.5",t.color),children:t.icon}),e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsx("div",{className:"font-medium text-sm",children:t.name}),e.jsx("div",{className:"text-xs text-muted-foreground",children:t.description})]}),e.jsx(Rt,{level:t.level})]},t.id))}),open:M,onOpenChange:q,align:"start",side:"top"})]})]}),e.jsx($e,{content:"Send message",side:"top",children:e.jsx(U.div,{whileTap:{scale:.97},transition:{duration:.15},children:e.jsx(E,{onClick:nt,disabled:!r.trim()||N,size:"default",className:"min-w-[60px]",children:A?e.jsx("div",{className:"rotating-symbol text-primary-foreground"}):e.jsx(Qt,{className:"h-4 w-4"})})})})]})]})})}),e.jsx("div",{className:G("fixed bottom-0 left-0 right-0 z-40 bg-background/95 backdrop-blur-sm border-t border-border shadow-lg",De&&"ring-2 ring-primary ring-offset-2",f),onDragEnter:ce,onDragLeave:ce,onDragOver:ce,onDrop:mt,children:e.jsxs("div",{className:"container mx-auto",children:[te.length>0&&e.jsx(Yt,{images:te,onRemove:Ke,className:"border-b border-border"}),e.jsx("div",{className:"p-3",children:e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsxs("div",{className:"flex items-center gap-1 shrink-0 mb-1",children:[e.jsx(ct,{trigger:e.jsxs(_t,{children:[e.jsx(Et,{asChild:!0,children:e.jsx(U.div,{whileTap:{scale:.97},transition:{duration:.15},children:e.jsxs(E,{variant:"ghost",size:"sm",disabled:N,className:"h-9 px-2 hover:bg-accent/50 gap-1",children:[e.jsx("span",{className:de.color,children:de.icon}),e.jsx("span",{className:"text-[10px] font-bold opacity-70",children:de.shortName}),e.jsx(yt,{className:"h-3 w-3 ml-0.5 opacity-50"})]})})}),e.jsxs(Tt,{side:"top",children:[e.jsx("p",{className:"text-xs font-medium",children:de.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:de.description})]})]}),content:e.jsx("div",{className:"w-[300px] p-1",children:ft.map(t=>e.jsxs("button",{onClick:()=>{V(t.id),Z(!1)},className:G("w-full flex items-start gap-3 p-3 rounded-md transition-colors text-left","hover:bg-accent",m===t.id&&"bg-accent"),children:[e.jsx("div",{className:"mt-0.5",children:e.jsx("span",{className:t.color,children:t.icon})}),e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsx("div",{className:"font-medium text-sm",children:t.name}),e.jsx("div",{className:"text-xs text-muted-foreground",children:t.description})]})]},t.id))}),open:B,onOpenChange:Z,align:"start",side:"top"}),e.jsx(ct,{trigger:e.jsxs(_t,{children:[e.jsx(Et,{asChild:!0,children:e.jsx(U.div,{whileTap:{scale:.97},transition:{duration:.15},children:e.jsxs(E,{variant:"ghost",size:"sm",disabled:N,className:"h-9 px-2 hover:bg-accent/50 gap-1",children:[e.jsx("span",{className:(Ne=ke.find(t=>t.id===c))==null?void 0:Ne.color,children:(ht=ke.find(t=>t.id===c))==null?void 0:ht.icon}),e.jsx("span",{className:"text-[10px] font-semibold opacity-70",children:(I=ke.find(t=>t.id===c))==null?void 0:I.shortName}),e.jsx(yt,{className:"h-3 w-3 ml-0.5 opacity-50"})]})})}),e.jsxs(Tt,{side:"top",children:[e.jsxs("p",{className:"text-xs font-medium",children:["Thinking: ",((Ee=ke.find(t=>t.id===c))==null?void 0:Ee.name)||"Auto"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:(Me=ke.find(t=>t.id===c))==null?void 0:Me.description})]})]}),content:e.jsx("div",{className:"w-[280px] p-1",children:ke.map(t=>e.jsxs("button",{onClick:()=>{T(t.id),q(!1)},className:G("w-full flex items-start gap-3 p-3 rounded-md transition-colors text-left","hover:bg-accent",c===t.id&&"bg-accent"),children:[e.jsx("span",{className:G("mt-0.5",t.color),children:t.icon}),e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsx("div",{className:"font-medium text-sm",children:t.name}),e.jsx("div",{className:"text-xs text-muted-foreground",children:t.description})]}),e.jsx(Rt,{level:t.level})]},t.id))}),open:M,onOpenChange:q,align:"start",side:"top"})]}),e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(Vt,{ref:Q,value:r,onChange:ge,onKeyDown:_e,onCompositionStart:We,onCompositionEnd:st,onPaste:me,placeholder:De?"Drop images here...":"Message Claude (@ for files, / for commands)...",disabled:N,className:G("resize-none pr-20 pl-3 py-2.5 transition-all duration-150",De&&"border-primary",pe>=240&&"overflow-y-auto scrollbar-thin"),style:{height:`${pe}px`,overflowY:pe>=240?"auto":"hidden"}}),e.jsxs("div",{className:"absolute right-1.5 bottom-1.5 flex items-center gap-0.5",children:[e.jsx($e,{content:"Expand (Ctrl+Shift+E)",side:"top",children:e.jsx(U.div,{whileTap:{scale:.97},transition:{duration:.15},children:e.jsx(E,{variant:"ghost",size:"icon",onClick:()=>ee(!0),disabled:N,className:"h-8 w-8 hover:bg-accent/50 transition-colors",children:e.jsx(Ot,{className:"h-3.5 w-3.5"})})})}),e.jsx($e,{content:A?"Stop generation":"Send message (Enter)",side:"top",children:e.jsx(U.div,{whileTap:{scale:.97},transition:{duration:.15},children:e.jsx(E,{onClick:A?p:nt,disabled:A?!1:!r.trim()||N,variant:A?"destructive":r.trim()?"default":"ghost",size:"icon",className:G("h-8 w-8 transition-all",r.trim()&&!A&&"shadow-sm"),children:A?e.jsx(ws,{className:"h-4 w-4"}):e.jsx(Qt,{className:"h-4 w-4"})})})})]}),e.jsx(Ae,{children:J&&C&&C.trim()&&e.jsx(Ns,{basePath:C.trim(),onSelect:Le,onClose:ze,initialQuery:Y})}),e.jsx(Ae,{children:a&&e.jsx(Vs,{projectPath:C,onSelect:tt,onClose:Se,initialQuery:x})})]}),b&&e.jsx("div",{className:"flex items-center gap-0.5 shrink-0 mb-1",children:b})]})})]})})]})})},cs=bt.forwardRef(Xs);cs.displayName="FloatingPromptInput";const Zs=({sessionId:i,projectId:A,projectPath:N,currentMessageIndex:k,onCheckpointSelect:C,onFork:f,refreshVersion:p=0,onCheckpointCreated:b,className:H})=>{const[r,L]=s.useState(null),[m,V]=s.useState(null),[c,T]=s.useState(new Set),[D,ee]=s.useState(!1),[B,Z]=s.useState(!1),[M,q]=s.useState(""),[J,z]=s.useState(!1),[Y,h]=s.useState(null),[a,j]=s.useState(null),[x,F]=s.useState(null),P=zt(),le=bt.useRef(!1);s.useEffect(()=>{te()},[i,A,N,p]);const te=async()=>{try{z(!0),h(null);const o=await ue.getSessionTimeline(i,A,N);if(L(o),o.currentCheckpointId&&o.rootNode){const O=Te(o.rootNode,o.currentCheckpointId);T(new Set(O))}}catch(o){console.error("Failed to load timeline:",o),h("Failed to load timeline")}finally{z(!1)}},Te=(o,O,ge=[])=>{if(o.checkpoint.id===O)return ge;for(const Le of o.children){const ze=Te(Le,O,[...ge,o.checkpoint.id]);if(ze.length>ge.length)return ze}return ge},De=async()=>{try{z(!0),h(null);const o=Date.now();await ue.createCheckpoint(i,A,N,k,M||void 0);const O=r?r.totalCheckpoints+1:1;P.checkpointCreated({checkpoint_number:O,session_duration_at_checkpoint:Date.now()-o}),b&&b(),q(""),ee(!1),await te()}catch(o){console.error("Failed to create checkpoint:",o),h("Failed to create checkpoint")}finally{z(!1)}},Ue=async o=>{if(confirm(`Restore to checkpoint "${o.description||o.id.slice(0,8)}"? Current state will be saved as a new checkpoint.`))try{z(!0),h(null);const O=new Date(o.timestamp).getTime(),ge=Date.now()-O;await ue.createCheckpoint(i,A,N,k,"Auto-save before restore"),await ue.restoreCheckpoint(o.id,i,A,N),P.checkpointRestored({checkpoint_id:o.id,time_since_checkpoint_ms:ge}),await te(),C(o)}catch(O){console.error("Failed to restore checkpoint:",O),h("Failed to restore checkpoint")}finally{z(!1)}},Q=async o=>{f(o.id)},fe=()=>{le.current=!0},Ce=()=>{setTimeout(()=>{le.current=!1},0)},pe=async o=>{if(!m){V(o);return}try{z(!0),h(null);const O=await ue.getCheckpointDiff(m.id,o.id,i,A);j(O),F(o),Z(!0)}catch(O){console.error("Failed to get diff:",O),h("Failed to compare checkpoints")}finally{z(!1)}},Fe=o=>{const O=new Set(c);O.has(o)?O.delete(o):O.add(o),T(O)},Re=(o,O=0)=>{const ge=c.has(o.checkpoint.id),Le=o.children.length>0,ze=(r==null?void 0:r.currentCheckpointId)===o.checkpoint.id,tt=(m==null?void 0:m.id)===o.checkpoint.id;return e.jsxs("div",{className:"relative",children:[O>0&&e.jsx("div",{className:"absolute left-0 top-0 w-6 h-6 border-l-2 border-b-2 border-muted-foreground/30",style:{left:`${(O-1)*24}px`,borderBottomLeftRadius:"8px"}}),e.jsxs(U.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{duration:.2,delay:O*.05},className:G("flex items-start gap-2 py-2",O>0&&"ml-6"),style:{paddingLeft:`${O*24}px`},children:[Le&&e.jsx(E,{variant:"ghost",size:"icon",className:"h-6 w-6 -ml-1",onClick:()=>Fe(o.checkpoint.id),children:ge?e.jsx(At,{className:"h-3 w-3"}):e.jsx(Es,{className:"h-3 w-3"})}),e.jsx(Xe,{className:G("flex-1 cursor-pointer transition-all hover:shadow-md",ze&&"border-primary ring-2 ring-primary/20",tt&&"border-blue-500 bg-blue-500/5",!Le&&"ml-5"),onClick:()=>V(o.checkpoint),children:e.jsx(xt,{className:"p-3",children:e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[ze&&e.jsx(Dt,{variant:"default",className:"text-xs",children:"Current"}),e.jsx("span",{className:"text-xs font-mono text-muted-foreground",children:o.checkpoint.id.slice(0,8)}),e.jsx("span",{className:"text-xs text-muted-foreground",children:Bs(new Date(o.checkpoint.timestamp),{addSuffix:!0})})]}),o.checkpoint.description&&e.jsx("p",{className:"text-sm font-medium mb-1",children:o.checkpoint.description}),e.jsx("p",{className:"text-xs text-muted-foreground line-clamp-2",children:o.checkpoint.metadata.userPrompt||"No prompt"}),e.jsxs("div",{className:"flex items-center gap-3 mt-2 text-xs text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(rs,{className:"h-3 w-3"}),o.checkpoint.metadata.totalTokens.toLocaleString()," tokens"]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ts,{className:"h-3 w-3"}),o.checkpoint.metadata.fileChanges," files"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(pt,{children:e.jsxs(gt,{children:[e.jsx(jt,{asChild:!0,children:e.jsx(E,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:Se=>{Se.stopPropagation(),Ue(o.checkpoint)},children:e.jsx(qs,{className:"h-3 w-3"})})}),e.jsx(vt,{children:"Restore to this checkpoint"})]})}),e.jsx(pt,{children:e.jsxs(gt,{children:[e.jsx(jt,{asChild:!0,children:e.jsx(E,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:Se=>{Se.stopPropagation(),Q(o.checkpoint)},children:e.jsx(Js,{className:"h-3 w-3"})})}),e.jsx(vt,{children:"Fork from this checkpoint"})]})}),e.jsx(pt,{children:e.jsxs(gt,{children:[e.jsx(jt,{asChild:!0,children:e.jsx(E,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:Se=>{Se.stopPropagation(),pe(o.checkpoint)},children:e.jsx(Ks,{className:"h-3 w-3"})})}),e.jsx(vt,{children:"Compare with another checkpoint"})]})})]})]})})})]}),ge&&Le&&e.jsxs("div",{className:"relative",children:[o.children.length>1&&e.jsx("div",{className:"absolute top-0 bottom-0 w-0.5 bg-muted-foreground/30",style:{left:`${(O+1)*24-1}px`}}),o.children.map(Se=>Re(Se,O+1))]})]},o.checkpoint.id)};return e.jsxs("div",{className:G("space-y-4",H),children:[e.jsx("div",{className:"rounded-lg border border-yellow-500/50 bg-yellow-500/10 p-3",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(et,{className:"h-4 w-4 text-yellow-600 mt-0.5"}),e.jsxs("div",{className:"text-xs",children:[e.jsx("p",{className:"font-medium text-yellow-600",children:"Experimental Feature"}),e.jsx("p",{className:"text-yellow-600/80",children:"Checkpointing may affect directory structure or cause data loss. Use with caution."})]})]})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ns,{className:"h-5 w-5 text-muted-foreground"}),e.jsx("h3",{className:"text-sm font-medium",children:"Timeline"}),r&&e.jsxs(Dt,{variant:"outline",className:"text-xs",children:[r.totalCheckpoints," checkpoints"]})]}),e.jsxs(E,{size:"sm",variant:"default",onClick:()=>ee(!0),disabled:J,children:[e.jsx(as,{className:"h-3 w-3 mr-1"}),"Checkpoint"]})]}),Y&&e.jsxs("div",{className:"flex items-center gap-2 text-xs text-destructive",children:[e.jsx(et,{className:"h-3 w-3"}),Y]}),r!=null&&r.rootNode?e.jsx("div",{className:"relative overflow-x-auto",children:Re(r.rootNode)}):e.jsx("div",{className:"text-center py-8 text-sm text-muted-foreground",children:J?"Loading timeline...":"No checkpoints yet"}),e.jsx(Ze,{open:D,onOpenChange:ee,children:e.jsxs(Ye,{children:[e.jsxs(wt,{children:[e.jsx(ut,{children:"Create Checkpoint"}),e.jsx(Nt,{children:"Save the current state of your session with an optional description."})]}),e.jsx("div",{className:"space-y-4 py-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(Qe,{htmlFor:"description",children:"Description (optional)"}),e.jsx(Ct,{id:"description",placeholder:"e.g., Before major refactoring",value:M,onChange:o=>q(o.target.value),onKeyDown:o=>{if(o.key==="Enter"&&!J){if(o.nativeEvent.isComposing||le.current)return;De()}},onCompositionStart:fe,onCompositionEnd:Ce})]})}),e.jsxs($t,{children:[e.jsx(E,{variant:"outline",onClick:()=>ee(!1),disabled:J,children:"Cancel"}),e.jsx(E,{onClick:De,disabled:J,children:"Create Checkpoint"})]})]})}),e.jsx(Ze,{open:B,onOpenChange:Z,children:e.jsxs(Ye,{className:"max-w-3xl",children:[e.jsxs(wt,{children:[e.jsx(ut,{children:"Checkpoint Comparison"}),e.jsxs(Nt,{children:['Changes between "',(m==null?void 0:m.description)||(m==null?void 0:m.id.slice(0,8)),'" and "',(x==null?void 0:x.description)||(x==null?void 0:x.id.slice(0,8)),'"']})]}),a&&e.jsxs("div",{className:"space-y-4 py-4 max-h-[60vh] overflow-y-auto",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx(Xe,{children:e.jsxs(xt,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Modified Files"}),e.jsx("div",{className:"text-2xl font-bold",children:a.modifiedFiles.length})]})}),e.jsx(Xe,{children:e.jsxs(xt,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Added Files"}),e.jsx("div",{className:"text-2xl font-bold text-green-600",children:a.addedFiles.length})]})}),e.jsx(Xe,{children:e.jsxs(xt,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Deleted Files"}),e.jsx("div",{className:"text-2xl font-bold text-red-600",children:a.deletedFiles.length})]})})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsxs(Dt,{variant:a.tokenDelta>0?"default":"secondary",children:[a.tokenDelta>0?"+":"",a.tokenDelta.toLocaleString()," tokens"]})}),a.modifiedFiles.length>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium mb-2",children:"Modified Files"}),e.jsx("div",{className:"space-y-1",children:a.modifiedFiles.map(o=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"font-mono",children:o.path}),e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsxs("span",{className:"text-green-600",children:["+",o.additions]}),e.jsxs("span",{className:"text-red-600",children:["-",o.deletions]})]})]},o.path))})]}),a.addedFiles.length>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium mb-2",children:"Added Files"}),e.jsx("div",{className:"space-y-1",children:a.addedFiles.map(o=>e.jsxs("div",{className:"text-xs font-mono text-green-600",children:["+ ",o]},o))})]}),a.deletedFiles.length>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium mb-2",children:"Deleted Files"}),e.jsx("div",{className:"space-y-1",children:a.deletedFiles.map(o=>e.jsxs("div",{className:"text-xs font-mono text-red-600",children:["- ",o]},o))})]})]}),e.jsx($t,{children:e.jsx(E,{variant:"outline",onClick:()=>{Z(!1),j(null),F(null)},children:"Close"})})]})})]})},Ys=({sessionId:i,projectId:A,projectPath:N,className:k})=>{const[C,f]=s.useState(!0),[p,b]=s.useState("smart"),[H,r]=s.useState(0),[L,m]=s.useState(10),[V,c]=s.useState(!1),[T,D]=s.useState(!1),[ee,B]=s.useState(null),[Z,M]=s.useState(null),q=[{value:"manual",label:"Manual Only"},{value:"per_prompt",label:"After Each Prompt"},{value:"per_tool_use",label:"After Tool Use"},{value:"smart",label:"Smart (Recommended)"}];s.useEffect(()=>{J()},[i,A,N]);const J=async()=>{try{c(!0),B(null);const h=await ue.getCheckpointSettings(i,A,N);f(h.auto_checkpoint_enabled),b(h.checkpoint_strategy),r(h.total_checkpoints)}catch(h){console.error("Failed to load checkpoint settings:",h),B("Failed to load checkpoint settings")}finally{c(!1)}},z=async()=>{try{D(!0),B(null),M(null),await ue.updateCheckpointSettings(i,A,N,C,p),M("Settings saved successfully"),setTimeout(()=>M(null),3e3)}catch(h){console.error("Failed to save checkpoint settings:",h),B("Failed to save checkpoint settings")}finally{D(!1)}},Y=async()=>{try{c(!0),B(null),M(null);const h=await ue.cleanupOldCheckpoints(i,A,N,L);M(`Removed ${h} old checkpoints`),setTimeout(()=>M(null),3e3),await J()}catch(h){console.error("Failed to cleanup checkpoints:",h),B("Failed to cleanup checkpoints")}finally{c(!1)}};return e.jsxs(U.div,{initial:{opacity:0,y:8},animate:{opacity:1,y:0},exit:{opacity:0,y:-8},transition:{duration:.15},className:G("space-y-4",k),children:[e.jsx("div",{className:"flex items-center justify-between pb-2 border-b border-border",children:e.jsxs("div",{className:"flex items-center gap-2.5",children:[e.jsx("div",{className:"p-1.5 rounded-md bg-primary/10",children:e.jsx(os,{className:"h-4 w-4 text-primary"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-heading-4 font-semibold",children:"Checkpoint Settings"}),e.jsx("p",{className:"text-caption text-muted-foreground mt-0.5",children:"Manage session checkpoints and recovery"})]})]})}),e.jsx("div",{className:"rounded-md border border-amber-200 dark:border-amber-900/50 bg-amber-50 dark:bg-amber-950/20 p-3",children:e.jsxs("div",{className:"flex items-start gap-2.5",children:[e.jsx(et,{className:"h-4 w-4 text-amber-600 dark:text-amber-500 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"space-y-0.5",children:[e.jsx("p",{className:"text-caption font-medium text-amber-900 dark:text-amber-100",children:"Experimental Feature"}),e.jsx("p",{className:"text-caption text-amber-700 dark:text-amber-300",children:"Checkpointing may affect directory structure or cause data loss. Use with caution."})]})]})}),ee&&e.jsx(U.div,{initial:{opacity:0,y:4},animate:{opacity:1,y:0},transition:{duration:.15},className:"rounded-md border border-destructive/50 bg-destructive/10 p-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(et,{className:"h-3.5 w-3.5 text-destructive"}),e.jsx("span",{className:"text-caption text-destructive",children:ee})]})}),Z&&e.jsx(U.div,{initial:{opacity:0,y:4},animate:{opacity:1,y:0},transition:{duration:.15},className:"rounded-md border border-green-600/50 bg-green-50 dark:bg-green-950/20 p-3",children:e.jsx("span",{className:"text-caption text-green-700 dark:text-green-400",children:Z})}),e.jsxs(Xe,{className:"p-5 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsx(Qe,{htmlFor:"auto-checkpoint",className:"text-label",children:"Automatic Checkpoints"}),e.jsx("p",{className:"text-caption text-muted-foreground",children:"Automatically create checkpoints based on the selected strategy"})]}),e.jsx(Ts,{id:"auto-checkpoint",checked:C,onCheckedChange:f,disabled:V})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Qe,{htmlFor:"strategy",className:"text-label",children:"Checkpoint Strategy"}),e.jsx(Ds,{value:p,onValueChange:h=>b(h),options:q,disabled:V||!C}),e.jsxs("p",{className:"text-caption text-muted-foreground",children:[p==="manual"&&"Checkpoints will only be created manually",p==="per_prompt"&&"A checkpoint will be created after each user prompt",p==="per_tool_use"&&"A checkpoint will be created after each tool use",p==="smart"&&"Checkpoints will be created after destructive operations"]})]}),e.jsx(U.div,{whileTap:{scale:.97},transition:{duration:.15},children:e.jsx(E,{onClick:z,disabled:V||T,className:"w-full",size:"default",children:T?e.jsxs(e.Fragment,{children:[e.jsx(Lt,{className:"h-4 w-4 mr-2 animate-spin"}),"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx(as,{className:"h-4 w-4 mr-2"}),"Save Settings"]})})})]}),e.jsxs(Xe,{className:"p-5 space-y-4",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"space-y-0.5",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Fs,{className:"h-4 w-4 text-muted-foreground"}),e.jsx(Qe,{className:"text-label",children:"Storage Management"})]}),e.jsxs("p",{className:"text-caption text-muted-foreground",children:["Total checkpoints: ",e.jsx("span",{className:"font-medium text-foreground",children:H})]})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Qe,{htmlFor:"keep-count",className:"text-label",children:"Keep Recent Checkpoints"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(Ct,{id:"keep-count",type:"number",min:"1",max:"100",value:L,onChange:h=>m(parseInt(h.target.value)||10),disabled:V,className:"flex-1 h-9"}),e.jsx(U.div,{whileTap:{scale:.97},transition:{duration:.15},children:e.jsxs(E,{variant:"outline",onClick:Y,disabled:V||H<=L,size:"sm",className:"hover:bg-destructive/10 hover:text-destructive hover:border-destructive/50",children:[e.jsx(Rs,{className:"h-3.5 w-3.5 mr-1.5"}),"Clean Up"]})})]}),e.jsxs("p",{className:"text-caption text-muted-foreground",children:["Remove old checkpoints, keeping only the most recent ",L]})]})]})]})},en=({left:i,right:A,initialSplit:N=50,minLeftWidth:k=200,minRightWidth:C=200,onSplitChange:f,className:p})=>{const[b,H]=s.useState(N),[r,L]=s.useState(!1),m=s.useRef(null),V=s.useRef(0),c=s.useRef(0),T=s.useRef(null),D=M=>{M.preventDefault(),L(!0),V.current=M.clientX,c.current=b,document.body.style.cursor="col-resize",document.body.style.userSelect="none"},ee=s.useCallback(M=>{!r||!m.current||(T.current&&cancelAnimationFrame(T.current),T.current=requestAnimationFrame(()=>{const q=m.current.offsetWidth,z=(M.clientX-V.current)/q*100,Y=c.current+z,h=k/q*100,a=100-C/q*100,j=Math.min(Math.max(Y,h),a);H(j),f==null||f(j)}))},[r,k,C,f]),B=s.useCallback(()=>{T.current&&cancelAnimationFrame(T.current),L(!1),document.body.style.cursor="",document.body.style.userSelect=""},[]);s.useEffect(()=>{if(r)return document.addEventListener("mousemove",ee),document.addEventListener("mouseup",B),()=>{document.removeEventListener("mousemove",ee),document.removeEventListener("mouseup",B)}},[r,ee,B]);const Z=M=>{if(!m.current)return;const q=M.shiftKey?10:2,J=m.current.offsetWidth,z=k/J*100,Y=100-C/J*100;let h=b;switch(M.key){case"ArrowLeft":M.preventDefault(),h=Math.max(b-q,z);break;case"ArrowRight":M.preventDefault(),h=Math.min(b+q,Y);break;case"Home":M.preventDefault(),h=z;break;case"End":M.preventDefault(),h=Y;break;default:return}H(h),f==null||f(h)};return e.jsxs("div",{ref:m,className:G("flex h-full w-full relative",p),children:[e.jsx("div",{className:"h-full overflow-hidden",style:{width:`${b}%`},children:i}),e.jsxs("div",{className:G("relative flex-shrink-0 group","w-1 hover:w-2 transition-all duration-150","bg-border hover:bg-primary/50","cursor-col-resize",r&&"bg-primary w-2"),onMouseDown:D,onKeyDown:Z,tabIndex:0,role:"separator","aria-label":"Resize panes","aria-valuenow":Math.round(b),"aria-valuemin":0,"aria-valuemax":100,children:[e.jsx("div",{className:"absolute inset-y-0 -left-2 -right-2 z-10"}),e.jsxs("div",{className:G("absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2","flex flex-col items-center justify-center gap-1","opacity-0 group-hover:opacity-100 transition-opacity",r&&"opacity-100"),children:[e.jsx("div",{className:"w-1 h-1 bg-primary rounded-full"}),e.jsx("div",{className:"w-1 h-1 bg-primary rounded-full"}),e.jsx("div",{className:"w-1 h-1 bg-primary rounded-full"})]})]}),e.jsx("div",{className:"h-full overflow-hidden flex-1",style:{width:`${100-b}%`},children:A})]})},tn=({initialUrl:i,onClose:A,isMaximized:N=!1,onToggleMaximize:k,onUrlChange:C,className:f})=>{const[p,b]=s.useState(i),[H,r]=s.useState(i),[L,m]=s.useState(!1),[V,c]=s.useState(!1),[T,D]=s.useState(""),ee=s.useRef(null),B=s.useRef(null),Z=s.useRef(null),M=s.useRef(!1);s.useEffect(()=>{const P=le=>{le.key==="Escape"&&N&&k&&k()};return document.addEventListener("keydown",P),()=>document.removeEventListener("keydown",P)},[N,k]),s.useEffect(()=>{console.log("[WebviewPreview] Component mounted with initialUrl:",i,"isMaximized:",N)},[]),s.useEffect(()=>{N&&B.current&&B.current.focus()},[N]),s.useEffect(()=>{if(p){m(!0),c(!1);const P=setTimeout(()=>{m(!1)},1e3);return()=>clearTimeout(P)}},[p]);const q=P=>{try{const te=new URL(P.startsWith("http")?P:`https://${P}`).href;console.log("[WebviewPreview] Navigating to:",te),b(te),r(te),c(!1),C==null||C(te)}catch{c(!0),D("Invalid URL")}},J=()=>{H.trim()&&q(H)},z=()=>{M.current=!0},Y=()=>{setTimeout(()=>{M.current=!1},0)},h=P=>{if(P.key==="Enter"){if(P.nativeEvent.isComposing||M.current)return;J()}},a=()=>{console.log("Go back")},j=()=>{console.log("Go forward")},x=()=>{m(!0),setTimeout(()=>m(!1),1e3)},F=()=>{q(i)};return e.jsxs("div",{ref:B,className:G("flex flex-col h-full bg-background border-l",f),tabIndex:-1,role:"region","aria-label":"Web preview",children:[e.jsxs("div",{className:"border-b bg-muted/30 flex-shrink-0",children:[e.jsxs("div",{className:"flex items-center justify-between px-3 py-2 border-b",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(It,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm font-medium",children:"Preview"}),L&&e.jsx(Lt,{className:"h-3 w-3 animate-spin text-muted-foreground"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[k&&e.jsx(pt,{children:e.jsxs(gt,{children:[e.jsx(jt,{asChild:!0,children:e.jsx(E,{variant:"ghost",size:"icon",onClick:k,className:"h-7 w-7",children:N?e.jsx(is,{className:"h-3.5 w-3.5"}):e.jsx(Ot,{className:"h-3.5 w-3.5"})})}),e.jsx(vt,{children:N?"Exit full screen (ESC)":"Enter full screen"})]})}),e.jsx(E,{variant:"ghost",size:"icon",onClick:A,className:"h-7 w-7 hover:bg-destructive/10 hover:text-destructive",children:e.jsx(dt,{className:"h-3.5 w-3.5"})})]})]}),e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(E,{variant:"ghost",size:"icon",onClick:a,disabled:!0,className:"h-8 w-8",children:e.jsx(Ms,{className:"h-4 w-4"})}),e.jsx(E,{variant:"ghost",size:"icon",onClick:j,disabled:!0,className:"h-8 w-8",children:e.jsx(Zt,{className:"h-4 w-4"})}),e.jsx(E,{variant:"ghost",size:"icon",onClick:x,disabled:L,className:"h-8 w-8",children:e.jsx(Ps,{className:G("h-4 w-4",L&&"animate-spin")})}),e.jsx(E,{variant:"ghost",size:"icon",onClick:F,className:"h-8 w-8",children:e.jsx(Is,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(Ct,{value:H,onChange:P=>r(P.target.value),onKeyDown:h,onCompositionStart:z,onCompositionEnd:Y,placeholder:"Enter URL...",className:"pr-10 h-8 text-sm font-mono"}),H!==p&&e.jsx(E,{variant:"ghost",size:"icon",onClick:J,className:"absolute right-1 top-1 h-6 w-6",children:e.jsx(Zt,{className:"h-3 w-3"})})]})]})]}),e.jsxs("div",{className:"flex-1 relative bg-background",ref:Z,children:[e.jsx(Ae,{children:L&&e.jsx(U.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 bg-background/80 backdrop-blur-sm z-10 flex items-center justify-center",children:e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsx(Lt,{className:"h-8 w-8 animate-spin text-primary"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading preview..."})]})})}),V?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full p-8",children:[e.jsx(et,{className:"h-12 w-12 text-destructive mb-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Failed to load preview"}),e.jsx("p",{className:"text-sm text-muted-foreground text-center mb-4",children:T||"The page could not be loaded. Please check the URL and try again."}),e.jsx(E,{onClick:x,variant:"outline",size:"sm",children:"Try Again"})]}):p?e.jsx("iframe",{ref:ee,src:p,className:"absolute inset-0 w-full h-full border-0",title:"Preview",sandbox:"allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox",onLoad:()=>m(!1),onError:()=>{c(!0),m(!1)}}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-full p-8 text-foreground",children:[e.jsx(It,{className:"h-16 w-16 text-muted-foreground/50 mb-6"}),e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"Enter a URL to preview"}),e.jsx("p",{className:"text-sm text-muted-foreground text-center mb-6 max-w-md",children:"Enter a URL in the address bar above to preview a website."}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx("span",{children:"Try entering"}),e.jsx("code",{className:"px-2 py-1 bg-muted/50 text-foreground rounded font-mono text-xs",children:"localhost:3000"}),e.jsx("span",{children:"or any other URL"})]})]})]})]})},es=bt.memo(tn);let ds;try{typeof window<"u"&&window.__TAURI__&&(ds=require("@tauri-apps/api/event").listen)}catch{console.log("[ClaudeCodeSession] Tauri APIs not available, using web mode")}const Oe=ds||((i,A)=>{console.log("[ClaudeCodeSession] Setting up DOM event listener for:",i);const N=k=>{console.log("[ClaudeCodeSession] DOM event received:",i,k.detail),A({payload:k.detail})};return window.addEventListener(i,N),Promise.resolve(()=>{console.log("[ClaudeCodeSession] Removing DOM event listener for:",i),window.removeEventListener(i,N)})}),un=({session:i,initialProjectPath:A="",className:N,onStreamingChange:k,onProjectPathChange:C})=>{const[f]=s.useState(A||(i==null?void 0:i.project_path)||""),[p,b]=s.useState([]),[H,r]=s.useState(!1),[L,m]=s.useState(null),[V,c]=s.useState([]),[T,D]=s.useState(!1),[ee,B]=s.useState(!i),[Z,M]=s.useState(0),[q,J]=s.useState(null),[z,Y]=s.useState(null),[h,a]=s.useState(!1),[j,x]=s.useState(0),[F,P]=s.useState(!1),[le,te]=s.useState(!1),[Te,De]=s.useState(!1),[Ue,Q]=s.useState(null),[fe,Ce]=s.useState(""),[pe,Fe]=s.useState([]),[Re,o]=s.useState(!1),[O,ge]=s.useState(""),[Le,ze]=s.useState(!1),[tt,Se]=s.useState(50),[We,st]=s.useState(!1),[Ge,nt]=s.useState(!1),_e=s.useRef(null),me=s.useRef([]),ce=s.useRef(!1),mt=s.useRef(null),Ke=s.useRef([]),de=s.useRef(!0),je=s.useRef(!1),He=s.useRef(Date.now()),Je=s.useRef(!1),se=s.useRef(null),X=s.useRef({firstMessageTime:null,promptsSent:0,toolsExecuted:0,toolsFailed:0,filesCreated:0,filesModified:0,filesDeleted:0,codeBlocksGenerated:0,errorsEncountered:0,lastActivityTime:Date.now(),toolExecutionTimes:[],checkpointCount:0,wasResumed:!!i,modelChanges:[]}),Ne=zt();$s("ClaudeCodeSession");const ht=As("claude_session");s.useEffect(()=>{C&&f&&C(f)},[]),s.useEffect(()=>{Ke.current=pe},[pe]);const I=s.useMemo(()=>i||(q?{id:q.sessionId,project_id:q.projectId,project_path:f,created_at:Date.now()}:null),[i,q,f]),Ee=s.useMemo(()=>p.filter((n,_)=>{var l,ie,u;if(n.isMeta&&!n.leafUuid&&!n.summary)return!1;if(n.type==="user"&&n.message){if(n.isMeta)return!1;const v=n.message;if(!v.content||Array.isArray(v.content)&&v.content.length===0)return!1;if(Array.isArray(v.content)){let ne=!1;for(const oe of v.content){if(oe.type==="text"){ne=!0;break}if(oe.type==="tool_result"){let qe=!1;if(oe.tool_use_id)for(let rt=_-1;rt>=0;rt--){const Ve=p[rt];if(Ve.type==="assistant"&&((l=Ve.message)!=null&&l.content)&&Array.isArray(Ve.message.content)){const ot=Ve.message.content.find(Be=>Be.type==="tool_use"&&Be.id===oe.tool_use_id);if(ot){const Be=(ie=ot.name)==null?void 0:ie.toLowerCase();(["task","edit","multiedit","todowrite","ls","read","glob","bash","write","grep"].includes(Be)||(u=ot.name)!=null&&u.startsWith("mcp__"))&&(qe=!0);break}}}if(!qe){ne=!0;break}}}if(!ne)return!1}}return!0}),[p]),Me=Ls({count:Ee.length,getScrollElement:()=>_e.current,estimateSize:()=>150,overscan:5});s.useEffect(()=>{console.log("[ClaudeCodeSession] State update:",{projectPath:f,session:i,extractedSessionInfo:q,effectiveSession:I,messagesCount:p.length,isLoading:H})},[f,i,q,I,p.length,H]),s.useEffect(()=>{i&&(Y(i.id),(async()=>(await t(),de.current&&await d()))())},[i]),s.useEffect(()=>{k==null||k(H,z)},[H,z,k]),s.useEffect(()=>{Ee.length>0&&setTimeout(()=>{const n=_e.current;n&&(Me.scrollToIndex(Ee.length-1,{align:"end",behavior:"auto"}),requestAnimationFrame(()=>{n.scrollTo({top:n.scrollHeight,behavior:"smooth"})}))},50)},[Ee.length,Me]),s.useEffect(()=>{const n=p.reduce((_,l)=>{var ie;return(ie=l.message)!=null&&ie.usage?_+l.message.usage.input_tokens+l.message.usage.output_tokens:l.usage?_+l.usage.input_tokens+l.usage.output_tokens:_},0);M(n)},[p]);const t=async()=>{if(i)try{r(!0),m(null);const n=await ue.loadSessionHistory(i.id,i.project_id);n&&n.length>0&&Xt.saveSession(i.id,i.project_id,i.project_path,n.length);const _=n.map(l=>({...l,type:l.type||"assistant"}));b(_),c(n.map(l=>JSON.stringify(l))),B(!1),setTimeout(()=>{if(_.length>0){const l=_e.current;l&&(Me.scrollToIndex(_.length-1,{align:"end",behavior:"auto"}),requestAnimationFrame(()=>{l.scrollTo({top:l.scrollHeight,behavior:"auto"})}))}},100)}catch(n){console.error("Failed to load session history:",n),m("Failed to load session history")}finally{r(!1)}},d=async()=>{if(i)try{(await ue.listRunningClaudeSessions()).find(l=>"process_type"in l&&l.process_type&&"ClaudeSession"in l.process_type?l.process_type.ClaudeSession.session_id===i.id:!1)&&(console.log("[ClaudeCodeSession] Found active session, reconnecting:",i.id),Y(i.id),g(i.id))}catch(n){console.error("Failed to check for active sessions:",n)}},g=async n=>{if(console.log("[ClaudeCodeSession] Reconnecting to session:",n),je.current){console.log("[ClaudeCodeSession] Already listening to session, skipping reconnect");return}me.current.forEach(u=>u()),me.current=[],Y(n),je.current=!0;const _=await Oe(`claude-output:${n}`,async u=>{try{if(console.log("[ClaudeCodeSession] Received claude-output on reconnect:",u.payload),!de.current)return;c(ne=>[...ne,u.payload]);const v=JSON.parse(u.payload);b(ne=>[...ne,v])}catch(v){console.error("Failed to parse message:",v,u.payload)}}),l=await Oe(`claude-error:${n}`,u=>{console.error("Claude error:",u.payload),de.current&&m(u.payload)}),ie=await Oe(`claude-complete:${n}`,async u=>{console.log("[ClaudeCodeSession] Received claude-complete on reconnect:",u.payload),de.current&&(r(!1),ce.current=!1)});me.current=[_,l,ie],de.current&&(r(!0),ce.current=!0)},w=async(n,_)=>{var l,ie;if(console.log("[ClaudeCodeSession] handleSendPrompt called with:",{prompt:n,model:_,projectPath:f,claudeSessionId:z,effectiveSession:I}),!f){m("Please select a project directory first");return}if(H){const u={id:`${Date.now()}-${Math.random().toString(36).substr(2,9)}`,prompt:n,model:_};Fe(v=>[...v,u]);return}try{if(r(!0),m(null),ce.current=!0,se.current&&(clearTimeout(se.current),se.current=null),se.current=setTimeout(()=>{de.current&&ce.current&&(console.warn("[ClaudeCodeSession] Timeout: No completion event received after 5 minutes, resetting loading state"),r(!1),ce.current=!1,je.current=!1,m("Session timed out - no response received. The process may still be running in the background."))},5*60*1e3),I&&!z&&Y(I.id),!je.current){let u=function(S){var he,be,R;try{if(!de.current)return;let W,lt;if(typeof S=="string"?(lt=S,W=JSON.parse(S)):(W=S,lt=JSON.stringify(S)),console.log("[ClaudeCodeSession] handleStreamMessage - message type:",W.type),c(Ie=>[...Ie,lt]),W.type==="assistant"&&((he=W.message)!=null&&he.content)&&W.message.content.filter(xe=>xe.type==="tool_use").forEach(xe=>{var Kt;X.current.toolsExecuted+=1,X.current.lastActivityTime=Date.now();const we=((Kt=xe.name)==null?void 0:Kt.toLowerCase())||"";we.includes("create")||we.includes("write")?X.current.filesCreated+=1:we.includes("edit")||we.includes("multiedit")||we.includes("search_replace")?X.current.filesModified+=1:we.includes("delete")&&(X.current.filesDeleted+=1),ht.trackStep(xe.name)}),W.type==="user"&&((be=W.message)!=null&&be.content)&&W.message.content.filter(xe=>xe.type==="tool_result").forEach(xe=>{(xe.is_error||!1)&&(X.current.toolsFailed+=1,X.current.errorsEncountered+=1,Ne.enhancedError({error_type:"tool_execution",error_code:"tool_failed",error_message:xe.content,context:"Tool execution failed",user_action_before_error:"executing_tool",recovery_attempted:!1,recovery_successful:!1,error_frequency:1,stack_trace_hash:void 0}))}),W.type==="assistant"&&((R=W.message)!=null&&R.content)){const Ie=W.message.content.filter(xe=>{var we;return xe.type==="text"&&((we=xe.text)==null?void 0:we.includes("```"))});Ie.length>0&&Ie.forEach(xe=>{const we=(xe.text.match(/```/g)||[]).length;X.current.codeBlocksGenerated+=Math.floor(we/2)})}W.type==="system"&&(W.subtype==="error"||W.error)&&(X.current.errorsEncountered+=1),b(Ie=>[...Ie,W])}catch(W){console.error("Failed to parse message:",W,S)}};me.current.forEach(S=>S()),me.current=[],je.current=!0,console.log("[ClaudeCodeSession] Setting up generic event listeners first");let v=z||(I==null?void 0:I.id)||null;const ne=async S=>{console.log("[ClaudeCodeSession] Attaching session-specific listeners for",S);const he=await Oe(`claude-output:${S}`,W=>{u(W.payload)}),be=await Oe(`claude-error:${S}`,W=>{console.error("Claude error (scoped):",W.payload),m(W.payload),se.current&&(clearTimeout(se.current),se.current=null),r(!1),ce.current=!1,je.current=!1}),R=await Oe(`claude-complete:${S}`,W=>{console.log("[ClaudeCodeSession] Received claude-complete (scoped):",W.payload),qe(W.payload)});me.current.forEach(W=>W()),me.current=[he,be,R]},oe=await Oe("claude-output",async S=>{var he,be;console.log("[ClaudeCodeSession] Received claude-output (generic):",(be=(he=S.payload)==null?void 0:he.substring)==null?void 0:be.call(he,0,100)),u(S.payload);try{const R=JSON.parse(S.payload);if(R.type==="system"&&R.subtype==="init"&&R.session_id&&(!v||v!==R.session_id)){if(console.log("[ClaudeCodeSession] Detected new session_id from generic listener:",R.session_id),v=R.session_id,Y(R.session_id),!q){const W=f.replace(/[^a-zA-Z0-9]/g,"-");J({sessionId:R.session_id,projectId:W}),Xt.saveSession(R.session_id,W,f,p.length)}await ne(R.session_id)}}catch(R){console.warn("[ClaudeCodeSession] Failed to parse message for session ID extraction:",R)}}),qe=async S=>{if(se.current&&(clearTimeout(se.current),se.current=null),r(!1),ce.current=!1,je.current=!1,I&&z){const he=p.length>0&&p[0].timestamp||Date.now(),be=Date.now()-he,R=X.current,W=R.firstMessageTime?R.firstMessageTime-He.current:void 0,lt=Date.now()-R.lastActivityTime,Ie=R.toolExecutionTimes.length>0?R.toolExecutionTimes.reduce((xe,we)=>xe+we,0)/R.toolExecutionTimes.length:void 0;Ne.enhancedSessionStopped({duration_ms:be,messages_count:p.length,reason:S?"completed":"error",time_to_first_message_ms:W,average_response_time_ms:Ie,idle_time_ms:lt,prompts_sent:R.promptsSent,tools_executed:R.toolsExecuted,tools_failed:R.toolsFailed,files_created:R.filesCreated,files_modified:R.filesModified,files_deleted:R.filesDeleted,total_tokens_used:Z,code_blocks_generated:R.codeBlocksGenerated,errors_encountered:R.errorsEncountered,model:R.modelChanges.length>0?R.modelChanges[R.modelChanges.length-1].to:"sonnet",has_checkpoints:R.checkpointCount>0,checkpoint_count:R.checkpointCount,was_resumed:R.wasResumed,agent_type:void 0,agent_name:void 0,agent_success:S,stop_source:"completed",final_state:S?"success":"failed",has_pending_prompts:pe.length>0,pending_prompts_count:pe.length})}if(I&&S)try{(await ue.getCheckpointSettings(I.id,I.project_id,f)).auto_checkpoint_enabled&&(await ue.checkAutoCheckpoint(I.id,I.project_id,f,n),x(be=>be+1))}catch(he){console.error("Failed to check auto checkpoint:",he)}if(Ke.current.length>0){const[he,...be]=Ke.current;Fe(be),setTimeout(()=>{w(he.prompt,he.model)},100)}},rt=await Oe("claude-error",S=>{console.error("Claude error:",S.payload),m(S.payload),se.current&&(clearTimeout(se.current),se.current=null),r(!1),ce.current=!1,je.current=!1}),Ve=await Oe("claude-complete",S=>{console.log("[ClaudeCodeSession] Received claude-complete (generic):",S.payload),qe(S.payload)});me.current=[oe,rt,Ve];const ot={type:"user",message:{content:[{type:"text",text:n}]}};b(S=>[...S,ot]),X.current.promptsSent+=1,X.current.lastActivityTime=Date.now(),X.current.firstMessageTime||(X.current.firstMessageTime=Date.now());const Be=X.current.modelChanges.length>0?X.current.modelChanges[X.current.modelChanges.length-1].to:X.current.wasResumed?"sonnet":_;Be!==_&&X.current.modelChanges.push({from:Be,to:_,timestamp:Date.now()});const it=n.match(/```[\s\S]*?```/g)||[],Gt=it.length>0,ms=p.filter(S=>S.user_message).length,hs=He.current?Date.now()-He.current:0,St=n.split(/\s+/).filter(S=>S.length>0).length;if(Ne.enhancedPromptSubmitted({prompt_length:n.length,model:_,has_attachments:!1,source:"keyboard",word_count:St,conversation_depth:ms,prompt_complexity:St<20?"simple":St<100?"moderate":"complex",contains_code:Gt,language_detected:Gt?(ie=(l=it==null?void 0:it[0])==null?void 0:l.match(/```(\w+)/))==null?void 0:ie[1]:void 0,session_age_ms:hs}),I&&!ee){console.log("[ClaudeCodeSession] Resuming session:",I.id),Ne.sessionResumed(I.id),Ne.modelSelected(_);try{await ue.resumeClaudeCode(f,I.id,n,_),console.log("[ClaudeCodeSession] resumeClaudeCode command completed")}catch(S){throw console.error("[ClaudeCodeSession] resumeClaudeCode command failed:",S),S}}else{console.log("[ClaudeCodeSession] Starting new session"),B(!1),Ne.sessionCreated(_,"prompt_input"),Ne.modelSelected(_);try{await ue.executeClaudeCode(f,n,_),console.log("[ClaudeCodeSession] executeClaudeCode command completed")}catch(S){throw console.error("[ClaudeCodeSession] executeClaudeCode command failed:",S),S}}}}catch(u){console.error("Failed to send prompt:",u),m("Failed to send prompt"),r(!1),ce.current=!1,je.current=!1,se.current&&(clearTimeout(se.current),se.current=null)}},y=async()=>{const n=V.join(`
`);await navigator.clipboard.writeText(n),D(!1)},$=async()=>{var _,l,ie;let n=`# Claude Code Session

`;n+=`**Project:** ${f}
`,n+=`**Date:** ${new Date().toISOString()}

`,n+=`---

`;for(const u of p)if(u.type==="system"&&u.subtype==="init")n+=`## System Initialization

`,n+=`- Session ID: \`${u.session_id||"N/A"}\`
`,n+=`- Model: \`${u.model||"default"}\`
`,u.cwd&&(n+=`- Working Directory: \`${u.cwd}\`
`),(_=u.tools)!=null&&_.length&&(n+=`- Tools: ${u.tools.join(", ")}
`),n+=`
`;else if(u.type==="assistant"&&u.message){n+=`## Assistant

`;for(const v of u.message.content||[])if(v.type==="text"){const ne=typeof v.text=="string"?v.text:((l=v.text)==null?void 0:l.text)||JSON.stringify(v.text||v);n+=`${ne}

`}else v.type==="tool_use"&&(n+=`### Tool: ${v.name}

`,n+=`\`\`\`json
${JSON.stringify(v.input,null,2)}
\`\`\`

`);u.message.usage&&(n+=`*Tokens: ${u.message.usage.input_tokens} in, ${u.message.usage.output_tokens} out*

`)}else if(u.type==="user"&&u.message){n+=`## User

`;for(const v of u.message.content||[])if(v.type==="text"){const ne=typeof v.text=="string"?v.text:((ie=v.text)==null?void 0:ie.text)||JSON.stringify(v.text);n+=`${ne}

`}else if(v.type==="tool_result"){n+=`### Tool Result

`;let ne="";typeof v.content=="string"?ne=v.content:v.content&&typeof v.content=="object"&&(v.content.text?ne=v.content.text:Array.isArray(v.content)?ne=v.content.map(oe=>typeof oe=="string"?oe:oe.text||JSON.stringify(oe)).join(`
`):ne=JSON.stringify(v.content,null,2)),n+=`\`\`\`
${ne}
\`\`\`

`}}else u.type==="result"&&(n+=`## Execution Result

`,u.result&&(n+=`${u.result}

`),u.error&&(n+=`**Error:** ${u.error}

`));await navigator.clipboard.writeText(n),D(!1)},ae=async()=>{await t(),x(n=>n+1)},K=()=>{X.current.checkpointCount+=1},re=async()=>{if(!(!z||!H))try{const n=p.length>0&&p[0].timestamp||Date.now(),_=Date.now()-n;await ue.cancelClaudeExecution(z);const l=X.current,ie=l.firstMessageTime?l.firstMessageTime-n.current:void 0,u=Date.now()-l.lastActivityTime,v=l.toolExecutionTimes.length>0?l.toolExecutionTimes.reduce((oe,qe)=>oe+qe,0)/l.toolExecutionTimes.length:void 0;Ne.enhancedSessionStopped({duration_ms:_,messages_count:p.length,reason:"user_stopped",time_to_first_message_ms:ie,average_response_time_ms:v,idle_time_ms:u,prompts_sent:l.promptsSent,tools_executed:l.toolsExecuted,tools_failed:l.toolsFailed,files_created:l.filesCreated,files_modified:l.filesModified,files_deleted:l.filesDeleted,total_tokens_used:Z,code_blocks_generated:l.codeBlocksGenerated,errors_encountered:l.errorsEncountered,model:l.modelChanges.length>0?l.modelChanges[l.modelChanges.length-1].to:"sonnet",has_checkpoints:l.checkpointCount>0,checkpoint_count:l.checkpointCount,was_resumed:l.wasResumed,agent_type:void 0,agent_name:void 0,agent_success:void 0,stop_source:"user_button",final_state:"cancelled",has_pending_prompts:pe.length>0,pending_prompts_count:pe.length}),me.current.forEach(oe=>oe()),me.current=[],r(!1),ce.current=!1,je.current=!1,m(null),Fe([]);const ne={type:"system",subtype:"info",result:"Session cancelled by user",timestamp:new Date().toISOString()};b(oe=>[...oe,ne])}catch(n){console.error("Failed to cancel execution:",n);const _={type:"system",subtype:"error",result:`Failed to cancel execution: ${n instanceof Error?n.message:"Unknown error"}. The process may still be running in the background.`,timestamp:new Date().toISOString()};b(l=>[...l,_]),me.current.forEach(l=>l()),me.current=[],r(!1),ce.current=!1,je.current=!1,m(null)}},ye=n=>{Q(n),Ce(`Fork-${new Date().toISOString().slice(0,10)}`),te(!0)},Pe=()=>{Je.current=!0},at=()=>{setTimeout(()=>{Je.current=!1},0)},ve=async()=>{if(!(!Ue||!fe.trim()||!I))try{r(!0),m(null);const n=`${Date.now()}-${Math.random().toString(36).substr(2,9)}`;await ue.forkFromCheckpoint(Ue,I.id,I.project_id,f,n,fe),console.log("Forked to new session:",n),te(!1),Q(null),Ce("")}catch(n){console.error("Failed to fork checkpoint:",n),m("Failed to fork checkpoint")}finally{r(!1)}},us=n=>{!Re&&!Le&&(ge(n),ze(!0))},Ut=()=>{o(!1),st(!1)},Wt=n=>{console.log("[ClaudeCodeSession] Preview URL changed to:",n),ge(n)},Ht=()=>{st(!We),We&&Se(50)};s.useEffect(()=>(de.current=!0,()=>{if(console.log("[ClaudeCodeSession] Component unmounting, cleaning up listeners"),de.current=!1,je.current=!1,se.current&&(clearTimeout(se.current),se.current=null),I){Ne.sessionCompleted();const n=He.current?Date.now()-He.current:0,_=p.filter(u=>u.user_message).length,l=new Set;p.forEach(u=>{var v;u.type==="assistant"&&((v=u.message)!=null&&v.content)&&u.message.content.filter(oe=>oe.type==="tool_use").forEach(oe=>l.add(oe.name))});const ie=Math.min(100,_*10+l.size*5+(n>3e5?20:n/15e3));Ne.sessionEngagement({session_duration_ms:n,messages_sent:_,tools_used:Array.from(l),files_modified:0,engagement_score:Math.round(ie)})}me.current.forEach(n=>n()),me.current=[],I&&ue.clearCheckpointManager(I.id).catch(n=>{console.error("Failed to clear checkpoint manager:",n)})}),[I,f]);const qt=e.jsxs("div",{ref:_e,className:"flex-1 overflow-y-auto relative pb-20",style:{contain:"strict"},children:[e.jsx("div",{className:"relative w-full max-w-6xl mx-auto px-4 pt-8 pb-4",style:{height:`${Math.max(Me.getTotalSize(),100)}px`,minHeight:"100px"},children:e.jsx(Ae,{children:Me.getVirtualItems().map(n=>{const _=Ee[n.index];return e.jsx(U.div,{"data-index":n.index,ref:l=>l&&Me.measureElement(l),initial:{opacity:0,y:8},animate:{opacity:1,y:0},exit:{opacity:0,y:-8},transition:{duration:.3},className:"absolute inset-x-4 pb-4",style:{top:n.start},children:e.jsx(zs,{message:_,streamMessages:p,onLinkDetected:us})},n.key)})})}),H&&e.jsx(U.div,{initial:{opacity:0,y:8},animate:{opacity:1,y:0},transition:{duration:.15},className:"flex items-center justify-center py-4 mb-20",children:e.jsx("div",{className:"rotating-symbol text-primary"})}),L&&e.jsx(U.div,{initial:{opacity:0,y:8},animate:{opacity:1,y:0},transition:{duration:.15},className:"rounded-lg border border-destructive/50 bg-destructive/10 p-4 text-sm text-destructive mb-20 w-full max-w-6xl mx-auto",children:L})]}),Bt=null;return Re&&We?e.jsx(Ae,{children:e.jsx(U.div,{className:"fixed inset-0 z-50 bg-background",initial:{opacity:0,y:8},animate:{opacity:1,y:0},exit:{opacity:0},transition:{duration:.2},children:e.jsx(es,{initialUrl:O,onClose:Ut,isMaximized:We,onToggleMaximize:Ht,onUrlChange:Wt,className:"h-full"})})}):e.jsx(ss,{children:e.jsxs("div",{className:G("flex flex-col h-full bg-background",N),children:[e.jsxs("div",{className:"w-full h-full flex flex-col",children:[e.jsx("div",{className:G("flex-1 overflow-hidden transition-all duration-300",h&&"sm:mr-96"),children:Re?e.jsx(en,{left:e.jsxs("div",{className:"h-full flex flex-col",children:[Bt,qt]}),right:e.jsx(es,{initialUrl:O,onClose:Ut,isMaximized:We,onToggleMaximize:Ht,onUrlChange:Wt}),initialSplit:tt,onSplitChange:Se,minLeftWidth:400,minRightWidth:400,className:"h-full"}):e.jsxs("div",{className:"h-full flex flex-col max-w-6xl mx-auto px-6",children:[Bt,qt,H&&p.length===0&&e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"rotating-symbol text-primary"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:i?"Loading session history...":"Initializing Claude Code..."})]})})]})}),e.jsxs(Os,{children:[e.jsx(Ae,{children:pe.length>0&&e.jsx(U.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:20},className:"fixed bottom-24 left-1/2 -translate-x-1/2 z-30 w-full max-w-3xl px-4",children:e.jsxs("div",{className:"bg-background/95 backdrop-blur-md border rounded-lg shadow-lg p-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-xs font-medium text-muted-foreground mb-1",children:["Queued Prompts (",pe.length,")"]}),e.jsx($e,{content:Ge?"Expand queue":"Collapse queue",side:"top",children:e.jsx(U.div,{whileTap:{scale:.97},transition:{duration:.15},children:e.jsx(E,{variant:"ghost",size:"icon",onClick:()=>nt(n=>!n),children:Ge?e.jsx(yt,{className:"h-3 w-3"}):e.jsx(At,{className:"h-3 w-3"})})})})]}),!Ge&&pe.map((n,_)=>e.jsxs(U.div,{initial:{opacity:0,y:4},animate:{opacity:1,y:0},exit:{opacity:0,y:-4},transition:{duration:.15,delay:_*.02},className:"flex items-start gap-2 bg-muted/50 rounded-md p-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsxs("span",{className:"text-xs font-medium text-muted-foreground",children:["#",_+1]}),e.jsx("span",{className:"text-xs px-1.5 py-0.5 bg-primary/10 text-primary rounded",children:n.model==="opus"?"Opus":"Sonnet"})]}),e.jsx("p",{className:"text-sm line-clamp-2 break-words",children:n.prompt})]}),e.jsx(U.div,{whileTap:{scale:.97},transition:{duration:.15},children:e.jsx(E,{variant:"ghost",size:"icon",className:"h-6 w-6 flex-shrink-0",onClick:()=>Fe(l=>l.filter(ie=>ie.id!==n.id)),children:e.jsx(dt,{className:"h-3 w-3"})})})]},n.id))]})})}),Ee.length>5&&e.jsx(U.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},transition:{delay:.5},className:"fixed bottom-32 right-6 z-50",children:e.jsxs("div",{className:"flex items-center bg-background/95 backdrop-blur-md border rounded-full shadow-lg overflow-hidden",children:[e.jsx($e,{content:"Scroll to top",side:"top",children:e.jsx(U.div,{whileTap:{scale:.97},transition:{duration:.15},children:e.jsx(E,{variant:"ghost",size:"sm",onClick:()=>{var n;Ee.length>0&&((n=_e.current)==null||n.scrollTo({top:0,behavior:"smooth"}),setTimeout(()=>{_e.current&&(_e.current.scrollTop=1,requestAnimationFrame(()=>{_e.current&&(_e.current.scrollTop=0)}))},500))},className:"px-3 py-2 hover:bg-accent rounded-none",children:e.jsx(yt,{className:"h-4 w-4"})})})}),e.jsx("div",{className:"w-px h-4 bg-border"}),e.jsx($e,{content:"Scroll to bottom",side:"top",children:e.jsx(U.div,{whileTap:{scale:.97},transition:{duration:.15},children:e.jsx(E,{variant:"ghost",size:"sm",onClick:()=>{if(Ee.length>0){const n=_e.current;n&&(Me.scrollToIndex(Ee.length-1,{align:"end",behavior:"auto"}),requestAnimationFrame(()=>{n.scrollTo({top:n.scrollHeight,behavior:"smooth"})}))}},className:"px-3 py-2 hover:bg-accent rounded-none",children:e.jsx(At,{className:"h-4 w-4"})})})})]})}),e.jsx("div",{className:G("fixed bottom-0 left-0 right-0 transition-all duration-300 z-50",h&&"sm:right-96"),children:e.jsx(cs,{ref:mt,onSend:w,onCancel:re,isLoading:H,disabled:!f,projectPath:f,extraMenuItems:e.jsxs(e.Fragment,{children:[I&&e.jsx($e,{content:"Session Timeline",side:"top",children:e.jsx(U.div,{whileTap:{scale:.97},transition:{duration:.15},children:e.jsx(E,{variant:"ghost",size:"icon",onClick:()=>a(!h),className:"h-9 w-9 text-muted-foreground hover:text-foreground",children:e.jsx(ns,{className:G("h-3.5 w-3.5",h&&"text-primary")})})})}),p.length>0&&e.jsx(ct,{trigger:e.jsx($e,{content:"Copy conversation",side:"top",children:e.jsx(U.div,{whileTap:{scale:.97},transition:{duration:.15},children:e.jsx(E,{variant:"ghost",size:"icon",className:"h-9 w-9 text-muted-foreground hover:text-foreground",children:e.jsx(Us,{className:"h-3.5 w-3.5"})})})}),content:e.jsxs("div",{className:"w-44 p-1",children:[e.jsx(E,{variant:"ghost",size:"sm",onClick:$,className:"w-full justify-start text-xs",children:"Copy as Markdown"}),e.jsx(E,{variant:"ghost",size:"sm",onClick:y,className:"w-full justify-start text-xs",children:"Copy as JSONL"})]}),open:T,onOpenChange:D,side:"top",align:"end"}),e.jsx($e,{content:"Checkpoint Settings",side:"top",children:e.jsx(U.div,{whileTap:{scale:.97},transition:{duration:.15},children:e.jsx(E,{variant:"ghost",size:"icon",onClick:()=>P(!F),className:"h-8 w-8 text-muted-foreground hover:text-foreground",children:e.jsx(os,{className:G("h-3.5 w-3.5",F&&"text-primary")})})})})]})})}),Z>0&&e.jsx("div",{className:"fixed bottom-0 left-0 right-0 z-30 pointer-events-none",children:e.jsx("div",{className:"max-w-6xl mx-auto",children:e.jsx("div",{className:"flex justify-end px-4 pb-2",children:e.jsx(U.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},className:"bg-background/95 backdrop-blur-md border rounded-full px-3 py-1 shadow-lg pointer-events-auto",children:e.jsxs("div",{className:"flex items-center gap-1.5 text-xs",children:[e.jsx(rs,{className:"h-3 w-3 text-muted-foreground"}),e.jsx("span",{className:"font-mono",children:Z.toLocaleString()}),e.jsx("span",{className:"text-muted-foreground",children:"tokens"})]})})})})})]}),e.jsx(Ae,{children:h&&I&&e.jsx(U.div,{initial:{x:"100%"},animate:{x:0},exit:{x:"100%"},transition:{duration:.2,ease:"easeOut"},className:"fixed right-0 top-0 h-full w-full sm:w-96 bg-background border-l border-border shadow-xl z-30 overflow-hidden",children:e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-border",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Session Timeline"}),e.jsx(E,{variant:"ghost",size:"icon",onClick:()=>a(!1),className:"h-8 w-8",children:e.jsx(dt,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:e.jsx(Zs,{sessionId:I.id,projectId:I.project_id,projectPath:f,currentMessageIndex:p.length-1,onCheckpointSelect:ae,onFork:ye,onCheckpointCreated:K,refreshVersion:j})})]})})})]}),e.jsx(Ze,{open:le,onOpenChange:te,children:e.jsxs(Ye,{children:[e.jsxs(wt,{children:[e.jsx(ut,{children:"Fork Session"}),e.jsx(Nt,{children:"Create a new session branch from the selected checkpoint."})]}),e.jsx("div",{className:"space-y-4 py-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(Qe,{htmlFor:"fork-name",children:"New Session Name"}),e.jsx(Ct,{id:"fork-name",placeholder:"e.g., Alternative approach",value:fe,onChange:n=>Ce(n.target.value),onKeyDown:n=>{if(n.key==="Enter"&&!H){if(n.nativeEvent.isComposing||Je.current)return;ve()}},onCompositionStart:Pe,onCompositionEnd:at})]})}),e.jsxs($t,{children:[e.jsx(E,{variant:"outline",onClick:()=>te(!1),disabled:H,children:"Cancel"}),e.jsx(E,{onClick:ve,disabled:H||!fe.trim(),children:"Create Fork"})]})]})}),F&&I&&e.jsx(Ze,{open:F,onOpenChange:P,children:e.jsx(Ye,{className:"max-w-2xl",children:e.jsx(Ys,{sessionId:I.id,projectId:I.project_id,projectPath:f,onClose:()=>P(!1)})})}),Te&&e.jsx(Ze,{open:Te,onOpenChange:De,children:e.jsxs(Ye,{className:"max-w-4xl max-h-[80vh] overflow-hidden",children:[e.jsxs(wt,{children:[e.jsx(ut,{children:"Slash Commands"}),e.jsxs(Nt,{children:["Manage project-specific slash commands for ",f]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsx(Ws,{projectPath:f})})]})})]})})};export{un as ClaudeCodeSession};
